‏<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حسابدار صوتی</title>
<style>
body {
  font-family: "Vazirmatn", sans-serif;
  background: #f4f6f7;
  margin: 0; padding: 0;
}
header {
  background: #00796b;
  color: white;
  text-align: center;
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
}
section { padding: 15px; }
button, .chip {
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  margin: 5px;
  font-size: 15px;
  background: #e0f2f1;
  color: #004d40;
}
button:hover, .chip:hover { background: #b2dfdb; cursor: pointer; }
.card {
  background: white;
  margin-top: 10px;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.value {
  font-size: 20px;
  font-weight: bold;
  color: #00796b;
}
</style>
</head>
<body>

<header>💬 حسابدار صوتی</header>

<section id="actions">
  <button class="chip" data-cmd="start">🎙️ شروع</button>
  <button class="chip" data-cmd="stop">⏹ توقف</button>
  <button class="chip" data-cmd="setup">⚙️ تنظیم اولیه</button>
  <button class="chip" data-cmd="json">📤 خروجی JSON</button>
</section>

<section class="card">
  <h3>خلاصه سریع</h3>
  <p>موجودی خالص: <span id="netWorth" class="value">۰</span></p>
  <p>درآمد امروز: <span id="todayIncome" class="value">۰</span></p>
  <p>خرج امروز: <span id="todayExpense" class="value">۰</span></p>
</section>

<section class="card">
  <h3>تراکنش‌های اخیر</h3>
  <ul id="transactions"></ul>
</section>

<script>
// --- ذخیره داده‌ها در مرورگر ---
const Storage = {
  key: "va-data",
  get() { return JSON.parse(localStorage.getItem(this.key) || "[]"); },
  set(v) { localStorage.setItem(this.key, JSON.stringify(v)); }
};

// --- داده‌های پایه (دارایی / بدهی / چک / قسط) ---
function getBase() { return JSON.parse(localStorage.getItem('va-base') || '{"assets":0,"debts":0,"checks":0,"installments":0}'); }
function setBase(b) { localStorage.setItem('va-base', JSON.stringify(b)); }

// --- صدا و گفتار ---
const R = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec;

function startListening() {
  if (!R) return alert("مرورگر از گفتار پشتیبانی نمی‌کند.");
  rec = new R();
  rec.lang = 'fa-IR';
  rec.start();
  rec.onresult = e => handleSpeech(e.results[0][0].transcript);
  rec.onerror = e => console.log(e);
}

function stopListening() {
  if (rec) rec.stop();
}

// --- پردازش گفتار ---
function handleSpeech(t) {
  say(`ثبت شد: ${t}`);
  const num = extractNumber(t);
  if (t.includes("خرج")) addTransaction(-num, t);
  else if (t.includes("گرفتم") || t.includes("واریز")) addTransaction(num, t);
  else if (t.includes("تنظیم اولیه")) setupWizard();
  else say("دستور نامشخص بود.");
  showSummary();
}

// --- استخراج عدد از متن فارسی ---
function extractNumber(t) {
  if (!t) return 0;
  t = t.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
  const n = parseInt(t.replace(/[^\d]/g, '')) || 0;
  return n;
}

// --- افزودن تراکنش ---
function addTransaction(amount, desc) {
  const data = Storage.get();
  data.push({ time: Date.now(), amount, desc });
  Storage.set(data);
  renderTransactions();
}

// --- نمایش تراکنش‌ها ---
function renderTransactions() {
  const list = Storage.get().slice(-10).reverse();
  const ul = document.getElementById("transactions");
  ul.innerHTML = list.map(x => `<li>${x.desc} → ${x.amount.toLocaleString('fa-IR')} ت</li>`).join("");
}

// --- محاسبه خلاصه ---
function showSummary() {
  const base = getBase();
  const list = Storage.get();
  let inc = 0, exp = 0;
  list.forEach(x => {
    if (x.amount > 0) inc += x.amount;
    else exp += Math.abs(x.amount);
  });
  const net = (base.assets - base.debts) + (inc - exp);

  document.getElementById('todayIncome').textContent = inc.toLocaleString('fa-IR');
  document.getElementById('todayExpense').textContent = exp.toLocaleString('fa-IR');
  document.getElementById('netWorth').textContent = net.toLocaleString('fa-IR');
}

// --- تنظیم اولیه ---
async function setupWizard() {
  say("بریم برای تنظیم اولیه.");
  const assets = await SpeechAsk("دارایی کل چقدره؟");
  const debts = await SpeechAsk("جمع بدهی‌ها چقدره؟");
  const checks = await SpeechAsk("جمع چک‌های باز چقدره؟");
  const ins = await SpeechAsk("جمع اقساط ماهانه چقدره؟");
  setBase({
    assets: extractNumber(assets),
    debts: extractNumber(debts),
    checks: extractNumber(checks),
    installments: extractNumber(ins)
  });
  say("ذخیره شد و خلاصه به‌روز شد.");
  showSummary();
}

// --- گفتار خروجی (پاسخ صوتی) ---
function say(txt) {
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = "fa-IR";
  speechSynthesis.speak(u);
}

// --- پرسش گفتاری ---
function SpeechAsk(prompt) {
  return new Promise(res => {
    say(prompt);
    if (!R) return res(prompt("پاسخ را بنویس:"));
    const r = new R();
    r.lang = 'fa-IR';
    r.onresult = e => { res(e.results[0][0].transcript); r.stop(); };
    r.onerror = () => res("");
    r.start();
  });
}

// --- رویداد دکمه‌ها ---
document.querySelectorAll(".chip").forEach(btn => {
  btn.onclick = () => {
    const key = btn.dataset.cmd;
    if (key === "start") startListening();
    if (key === "stop") stopListening();
    if (key === "setup") setupWizard();
    if (key === "json") exportJSON();
  };
});

// --- خروجی JSON ---
function exportJSON() {
  const blob = new Blob([JSON.stringify(Storage.get(), null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "transactions.json";
  a.click();
}

// شروع اولیه
renderTransactions();
showSummary();
</script>
</body>
</html>
