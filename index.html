â€<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± ØµÙˆØªÛŒ</title>
<style>
body {
  font-family: "Vazirmatn", sans-serif;
  background: #f4f6f7;
  margin: 0; padding: 0;
}
header {
  background: #00796b;
  color: white;
  text-align: center;
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
}
section { padding: 15px; }
button, .chip {
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  margin: 5px;
  font-size: 15px;
  background: #e0f2f1;
  color: #004d40;
}
button:hover, .chip:hover { background: #b2dfdb; cursor: pointer; }
.card {
  background: white;
  margin-top: 10px;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.value {
  font-size: 20px;
  font-weight: bold;
  color: #00796b;
}
</style>
</head>
<body>

<header>ğŸ’¬ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± ØµÙˆØªÛŒ</header>

<section id="actions">
  <button class="chip" data-cmd="start">ğŸ™ï¸ Ø´Ø±ÙˆØ¹</button>
  <button class="chip" data-cmd="stop">â¹ ØªÙˆÙ‚Ù</button>
  <button class="chip" data-cmd="setup">âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡</button>
  <button class="chip" data-cmd="json">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
</section>

<section class="card">
  <h3>Ø®Ù„Ø§ØµÙ‡ Ø³Ø±ÛŒØ¹</h3>
  <p>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø§Ù„Øµ: <span id="netWorth" class="value">Û°</span></p>
  <p>Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²: <span id="todayIncome" class="value">Û°</span></p>
  <p>Ø®Ø±Ø¬ Ø§Ù…Ø±ÙˆØ²: <span id="todayExpense" class="value">Û°</span></p>
</section>

<section class="card">
  <h3>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
  <ul id="transactions"></ul>
</section>

<script>
// --- Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ---
const Storage = {
  key: "va-data",
  get() { return JSON.parse(localStorage.getItem(this.key) || "[]"); },
  set(v) { localStorage.setItem(this.key, JSON.stringify(v)); }
};

// --- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ (Ø¯Ø§Ø±Ø§ÛŒÛŒ / Ø¨Ø¯Ù‡ÛŒ / Ú†Ú© / Ù‚Ø³Ø·) ---
function getBase() { return JSON.parse(localStorage.getItem('va-base') || '{"assets":0,"debts":0,"checks":0,"installments":0}'); }
function setBase(b) { localStorage.setItem('va-base', JSON.stringify(b)); }

// --- ØµØ¯Ø§ Ùˆ Ú¯ÙØªØ§Ø± ---
const R = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec;

function startListening() {
  if (!R) return alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
  rec = new R();
  rec.lang = 'fa-IR';
  rec.start();
  rec.onresult = e => handleSpeech(e.results[0][0].transcript);
  rec.onerror = e => console.log(e);
}

function stopListening() {
  if (rec) rec.stop();
}

// --- Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú¯ÙØªØ§Ø± ---
function handleSpeech(t) {
  say(`Ø«Ø¨Øª Ø´Ø¯: ${t}`);
  const num = extractNumber(t);
  if (t.includes("Ø®Ø±Ø¬")) addTransaction(-num, t);
  else if (t.includes("Ú¯Ø±ÙØªÙ…") || t.includes("ÙˆØ§Ø±ÛŒØ²")) addTransaction(num, t);
  else if (t.includes("ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡")) setupWizard();
  else say("Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø´Ø®Øµ Ø¨ÙˆØ¯.");
  showSummary();
}

// --- Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ø¯Ø¯ Ø§Ø² Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ ---
function extractNumber(t) {
  if (!t) return 0;
  t = t.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
  const n = parseInt(t.replace(/[^\d]/g, '')) || 0;
  return n;
}

// --- Ø§ÙØ²ÙˆØ¯Ù† ØªØ±Ø§Ú©Ù†Ø´ ---
function addTransaction(amount, desc) {
  const data = Storage.get();
  data.push({ time: Date.now(), amount, desc });
  Storage.set(data);
  renderTransactions();
}

// --- Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ ---
function renderTransactions() {
  const list = Storage.get().slice(-10).reverse();
  const ul = document.getElementById("transactions");
  ul.innerHTML = list.map(x => `<li>${x.desc} â†’ ${x.amount.toLocaleString('fa-IR')} Øª</li>`).join("");
}

// --- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®Ù„Ø§ØµÙ‡ ---
function showSummary() {
  const base = getBase();
  const list = Storage.get();
  let inc = 0, exp = 0;
  list.forEach(x => {
    if (x.amount > 0) inc += x.amount;
    else exp += Math.abs(x.amount);
  });
  const net = (base.assets - base.debts) + (inc - exp);

  document.getElementById('todayIncome').textContent = inc.toLocaleString('fa-IR');
  document.getElementById('todayExpense').textContent = exp.toLocaleString('fa-IR');
  document.getElementById('netWorth').textContent = net.toLocaleString('fa-IR');
}

// --- ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ ---
async function setupWizard() {
  say("Ø¨Ø±ÛŒÙ… Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡.");
  const assets = await SpeechAsk("Ø¯Ø§Ø±Ø§ÛŒÛŒ Ú©Ù„ Ú†Ù‚Ø¯Ø±Ù‡ØŸ");
  const debts = await SpeechAsk("Ø¬Ù…Ø¹ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ú†Ù‚Ø¯Ø±Ù‡ØŸ");
  const checks = await SpeechAsk("Ø¬Ù…Ø¹ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø² Ú†Ù‚Ø¯Ø±Ù‡ØŸ");
  const ins = await SpeechAsk("Ø¬Ù…Ø¹ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ Ú†Ù‚Ø¯Ø±Ù‡ØŸ");
  setBase({
    assets: extractNumber(assets),
    debts: extractNumber(debts),
    checks: extractNumber(checks),
    installments: extractNumber(ins)
  });
  say("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ùˆ Ø®Ù„Ø§ØµÙ‡ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯.");
  showSummary();
}

// --- Ú¯ÙØªØ§Ø± Ø®Ø±ÙˆØ¬ÛŒ (Ù¾Ø§Ø³Ø® ØµÙˆØªÛŒ) ---
function say(txt) {
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = "fa-IR";
  speechSynthesis.speak(u);
}

// --- Ù¾Ø±Ø³Ø´ Ú¯ÙØªØ§Ø±ÛŒ ---
function SpeechAsk(prompt) {
  return new Promise(res => {
    say(prompt);
    if (!R) return res(prompt("Ù¾Ø§Ø³Ø® Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³:"));
    const r = new R();
    r.lang = 'fa-IR';
    r.onresult = e => { res(e.results[0][0].transcript); r.stop(); };
    r.onerror = () => res("");
    r.start();
  });
}

// --- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ---
document.querySelectorAll(".chip").forEach(btn => {
  btn.onclick = () => {
    const key = btn.dataset.cmd;
    if (key === "start") startListening();
    if (key === "stop") stopListening();
    if (key === "setup") setupWizard();
    if (key === "json") exportJSON();
  };
});

// --- Ø®Ø±ÙˆØ¬ÛŒ JSON ---
function exportJSON() {
  const blob = new Blob([JSON.stringify(Storage.get(), null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "transactions.json";
  a.click();
}

// Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
renderTransactions();
showSummary();
</script>
</body>
</html>
