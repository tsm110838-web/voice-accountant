<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± ØµÙˆØªÛŒ Ù¾Ø±Ùˆ</title>
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;VA Pro&quot;,&quot;short_name&quot;:&quot;VA&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;}">
<meta name="theme-color" content="#0b9981">
<!-- Chart.js Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
@font-face{font-family:IRANSansX;src:local("Tahoma");font-display:swap}
:root{
  --bg:#f6f8f9; --card:#fff; --line:#e6eef2; --txt:#111;
  --muted:#64748b; --pri:#0b9981; --ok:#11825f; --danger:#b33636;
  --chip:#e7f3f5
}
html,body{margin:0;padding:0;font-family:IRANSansX,system-ui;background:var(--bg);color:var(--txt);height:100%}
.small{font-size:12px;color:var(--muted)}
.hidden{display:none}
.topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--pri);color:#fff}
.topbar h1{font-size:18px;margin:0}
.spacer{flex:1}
.icon-btn{background:transparent;border:none;color:inherit;font-size:20px;padding:6px}
.drawer{position:fixed;inset:0 0 0 auto;width:min(320px,86vw);background:#fff;border-left:1px solid var(--line);transform:translateX(100%);transition:.25s;z-index:30;display:flex;flex-direction:column}
.drawer.show{transform:translateX(0)}
.drawer-head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
.drawer-list{display:flex;flex-direction:column;padding:8px}
.navlink{padding:10px 12px;margin:4px;background:#fff;border:1px solid var(--line);border-radius:12px;text-align:right}
.drawer-foot{margin-top:auto;padding:10px;border-top:1px solid var(--line)}
main{padding:12px}
.cards{display:grid;gap:8px}
@media(min-width:900px){.cards{grid-template-columns:repeat(4,1fr)}}
@media(max-width:899px){.cards{grid-template-columns:repeat(2,1fr)}}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.list{list-style:none;margin:0;padding:0}
.list li{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px;margin:6px 0}
.row{display:flex;gap:8px;align-items:center}
.grid{display:grid;gap:8px}
.g2{grid-template-columns:1fr 1fr}
.g4{grid-template-columns:repeat(4,1fr)}
.grow{flex:1}
.col-span2{grid-column:span 2}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-family:inherit}
.btn{border:none;border-radius:10px;padding:10px 14px;background:#e7f3f5;color:#064a50;cursor:pointer}
.btn.primary{background:var(--pri);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.danger{background:var(--danger);color:#fff}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid #cfe9ec}
.panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
.kbd{font:12px/1.6 ui-monospace,monospace;background:#111;color:#fff;padding:0 6px;border-radius:6px}
.badge{background:#eee;padding:2px 6px;border-radius:6px}
footer{height:40px}
.theme-parmis{--pri:#0d8;--ok:#0c8;--danger:#e33}
.theme-dark{--bg:#0b1220;--card:#0e1626;--line:#1e293b;--txt:#e2e8f0;--muted:#94a3b8;--pri:#14b8a6;--ok:#10b981;--danger:#f87171;--chip:#0f1b2a}
.theme-modern{--pri:#6366f1;--ok:#10b981;--danger:#ef4444}
</style>
</head>
<body>
<header class="topbar">
  <button id="btnMenu" class="icon-btn">â˜°</button>
  <h1>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± ØµÙˆØªÛŒ Ù¾Ø±Ùˆ</h1>
  <span id="periodLabel" class="badge">Ø¯ÙˆØ±Ù‡ 1404</span>
  <div class="spacer"></div>
  <button id="btnVoice" class="icon-btn" title="Ù‡ÙˆØ´ ØµÙˆØªÛŒ">ğŸ¤</button>
  <button id="btnBackup" class="icon-btn" title="Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ">ğŸ’¾</button>
</header>

<!-- Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒ -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="drawer-head">
    <strong>Ù…Ù†Ùˆ</strong>
    <button id="btnCloseDrawer" class="icon-btn">âœ•</button>
  </div>
  <nav class="drawer-list">
    <button class="navlink" data-tab="dashboard">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
    <button class="navlink" data-tab="tx">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</button>
    <button class="navlink" data-tab="accounts">Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</button>
    <button class="navlink" data-tab="cheques">Ú†Ú©â€ŒÙ‡Ø§</button>
    <button class="navlink" data-tab="installments">Ø§Ù‚Ø³Ø§Ø·</button>
    <button class="navlink" data-tab="building">Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®ØªÙ…Ø§Ù†</button>
    <button class="navlink" data-tab="reports">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
    <button class="navlink" data-tab="tools">Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</button>
    <button class="navlink" data-tab="settings">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
  </nav>
  <div class="drawer-foot small">
    <div class="row">
      <label class="small">Ù¾Ø±ÙˆÙØ§ÛŒÙ„:</label>
      <select id="profileSel" class="grow">
        <option value="pro">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„</option>
        <option value="lite">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø³Ø¨Ú© (Ø³Ø§Ø®ØªÙ…Ø§Ù†/Ø´Ø®ØµÛŒ)</option>
      </select>
    </div>
  </div>
</aside>

<main>
  <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
  <section id="view-dashboard" class="view">
    <div class="cards">
      <div class="card">
        <h3>Ø®Ù„Ø§ØµÙ‡ Ø³Ø±ÛŒØ¹</h3>
        <div class="list">
          <li><span>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø§Ù„Øµ</span><strong id="sumNet">â€“</strong></li>
          <li><span>Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²</span><strong id="sumIncToday">â€“</strong></li>
          <li><span>Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ù…Ø±ÙˆØ²</span><strong id="sumExpToday">â€“</strong></li>
        </div>
        <div class="chips">
          <button class="chip" id="btnAddIncome">+ Ø¯Ø±Ø¢Ù…Ø¯</button>
          <button class="chip" id="btnAddExpense">+ Ù‡Ø²ÛŒÙ†Ù‡</button>
          <button class="chip" id="btnTransfer">â†” Ø§Ù†ØªÙ‚Ø§Ù„</button>
          <button class="chip" id="btnImportSMS">Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø² Ù¾ÛŒØ§Ù…Ú© Ø¨Ø§Ù†Ú©ÛŒ</button>
        </div>
      </div>
      <div class="card col-span2">
        <h3>Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø±Ø¢Ù…Ø¯/Ù‡Ø²ÛŒÙ†Ù‡ (Û³ Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±)</h3>
        <canvas id="chartIE" height="110"></canvas>
      </div>
      <div class="card">
        <h3>Ø³Ù‡Ù… Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</h3>
        <canvas id="chartAccounts" height="110"></canvas>
      </div>
    </div>

    <div class="panel">
      <h3>Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</h3>
      <div class="grid g2">
        <div>
          <label>Ù…Ø¨Ù„Øº</label>
          <div class="row">
            <input id="txAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3000000" inputmode="numeric">
            <button id="btnCalc" class="btn">ğŸ§®</button>
          </div>
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
          <select id="txMethod">
            <option value="cash">Ù†Ù‚Ø¯ÛŒ</option>
            <option value="cheque">Ú†Ú©ÛŒ</option>
            <option value="inst">Ù‚Ø³Ø·ÛŒ</option>
          </select>
        </div>
        <div>
          <label>Ø§Ø² Ø­Ø³Ø§Ø¨</label>
          <select id="txFrom"></select>
        </div>
        <div>
          <label>Ø¨Ù‡ Ø­Ø³Ø§Ø¨</label>
          <select id="txTo"></select>
        </div>
        <div class="col-span2">
          <label>ØªÙˆØ¶ÛŒØ­</label>
          <input id="txNote" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø®Ø±ÛŒØ¯ Ø³ÙˆÙ¾Ø± / Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² ...">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveExpense" class="btn danger">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
        <button id="btnSaveIncome" class="btn ok">Ø«Ø¨Øª Ø¯Ø±Ø¢Ù…Ø¯</button>
        <button id="btnSaveTransfer" class="btn">Ø«Ø¨Øª Ø§Ù†ØªÙ‚Ø§Ù„</button>
        <button id="btnVoiceExplain" class="btn">ğŸ™ï¸ ØªÙˆØ¶ÛŒØ­ ØµÙˆØªÛŒ</button>
      </div>
    </div>

    <div class="panel">
      <h3>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
      <ul id="recentList" class="list"></ul>
    </div>
  </section>

  <!-- Ø³Ø§ÛŒØ± Ù†Ù…Ø§Ù‡Ø§: ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§/Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§/Ú†Ú©â€ŒÙ‡Ø§/Ø§Ù‚Ø³Ø§Ø·/Ø³Ø§Ø®ØªÙ…Ø§Ù†/Ú¯Ø²Ø§Ø±Ø´/Ø§Ø¨Ø²Ø§Ø±/ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
  <section id="view-tx" class="view hidden">
    <div class="row" style="margin-bottom:8px">
      <input id="txSearch" class="grow" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
      <select id="txFilter">
        <option value="all">Ù‡Ù…Ù‡</option>
        <option value="inc">Ø¯Ø±ÛŒØ§ÙØª</option>
        <option value="exp">Ù¾Ø±Ø¯Ø§Ø®Øª</option>
        <option value="tr">Ø§Ù†ØªÙ‚Ø§Ù„</option>
      </select>
    </div>
    <ul id="txList" class="list"></ul>
  </section>

  <section id="view-accounts" class="view hidden">
    <div class="row">
      <button id="btnAccAdd" class="btn ok">+ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</button>
      <div class="spacer"></div>
      <button id="btnAccTree" class="btn">Ø¯Ø±Ø®Øª Ø³Ø±ÙØµÙ„/Ù…Ø¹ÛŒÙ†/ØªÙØµÛŒÙ„ÛŒ</button>
    </div>
    <ul id="accList" class="list"></ul>
    <div id="accTreePanel" class="panel hidden">
      <h3>Ø¯Ø±Ø®Øª Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</h3>
      <ul id="accTree" class="list"></ul>
    </div>
  </section>

  <section id="view-cheques" class="view hidden">
    <div class="row">
      <button id="btnAddCheque" class="btn ok">+ Ú†Ú©</button>
      <select id="chKind" class="grow">
        <option value="recv">Ø§Ø³Ù†Ø§Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ</option>
        <option value="pay">Ø§Ø³Ù†Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®ØªÙ†ÛŒ</option>
      </select>
    </div>
    <ul id="chList" class="list"></ul>
  </section>

  <section id="view-installments" class="view hidden">
    <div class="grid g4">
      <div><label>Ø¹Ù†ÙˆØ§Ù†/ÙˆØ§Ù…</label><input id="insNote" placeholder="ÙˆØ§Ù… Ø®ÙˆØ¯Ø±Ùˆ"></div>
      <div><label>ØªØ¹Ø¯Ø§Ø¯</label><input id="insCount" inputmode="numeric" value="12"></div>
      <div><label>Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø·</label><input id="insPer" inputmode="numeric"></div>
      <div><label>Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ</label><input id="insNext" type="date"></div>
    </div>
    <div class="row" style="margin:8px 0">
      <button id="btnAddInst" class="btn ok">+ Ø§ÙØ²ÙˆØ¯Ù† Ù‚Ø³Ø·</button>
    </div>
    <ul id="insList" class="list"></ul>
  </section>

  <section id="view-building" class="view hidden">
    <div class="row">
      <select id="bSelect" class="grow"></select>
      <button id="btnBAdd" class="btn ok">+ Ø³Ø§Ø®ØªÙ…Ø§Ù†/Ù…Ø¬ØªÙ…Ø¹</button>
    </div>
    <div class="grid g4">
      <div class="col-span2"><label>ÙˆØ§Ø­Ø¯</label><input id="bUnitName" placeholder="ÙˆØ§Ø­Ø¯ Û·"></div>
      <div><label>Ø³Ù‡Ù… (%)</label><input id="bUnitShare" inputmode="numeric" value="0"></div>
      <div><label>&nbsp;</label><button id="btnBAddUnit" class="btn">+ Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯</button></div>
    </div>
    <div class="panel">
      <h3>ÙˆØ§Ø­Ø¯Ù‡Ø§</h3>
      <ul id="bUnits" class="list"></ul>
    </div>
    <div class="panel">
      <h3>ØªÙ‚Ø³ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø´ØªØ±Ú©</h3>
      <div class="grid g4">
        <div class="col-span2"><label>Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡</label><input id="bCostNote" placeholder="Ù†Ø¸Ø§ÙØª/Ø¢Ø¨ÙˆÙ†Ù…Ø§Ù†/Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ"></div>
        <div><label>Ù…Ø¨Ù„Øº Ú©Ù„</label><input id="bCostTotal" inputmode="numeric"></div>
        <div><label>&nbsp;</label><button id="btnBSplit" class="btn">ØªÙ‚Ø³ÛŒÙ… Ø¨ÛŒÙ† ÙˆØ§Ø­Ø¯Ù‡Ø§</button></div>
      </div>
      <ul id="bSplitList" class="list"></ul>
    </div>
  </section>

  <section id="view-reports" class="view hidden">
    <div class="row">
      <button id="btnExportJSON" class="btn">Export JSON</button>
      <button id="btnExportCSV" class="btn">Export CSV</button>
      <button id="btnExportPDF" class="btn">Export PDF</button>
    </div>
    <div id="reportSummary" class="panel small">â€”</div>
    <div class="card">
      <h3>Ù†Ù…ÙˆØ¯Ø§Ø± ØªÙÚ©ÛŒÚ©ÛŒ Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§</h3>
      <canvas id="chartByAccount" height="150"></canvas>
    </div>
  </section>

  <section id="view-tools" class="view hidden">
    <div class="chips">
      <button id="toolCalc" class="chip">ğŸ§® Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</button>
      <button id="toolFx" class="chip">ğŸ’± Ù…Ø¨Ø¯Ù„ Ø§Ø±Ø²</button>
      <button id="toolNote" class="chip">ğŸ“ Ø¯ÙØªØ±Ú†Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button>
    </div>
    <div id="toolsArea" class="panel small">Ø§Ø¨Ø²Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯â€¦</div>
  </section>

  <section id="view-settings" class="view hidden">
    <div class="grid g4">
      <div><label>ØªÙ…</label>
        <select id="themeSel">
          <option value="">Ø³Ø§Ø¯Ù‡</option>
          <option value="theme-parmis">Ù¾Ø§Ø±Ù…ÛŒØ³</option>
          <option value="theme-modern">Ù…Ø¯Ø±Ù†</option>
          <option value="theme-dark">ØªÛŒØ±Ù‡</option>
        </select>
      </div>
      <div><label>Ø­Ø§Ù„Øª ØµÙˆØªÛŒ</label>
        <select id="voiceMode"><option value="on">ÙØ¹Ø§Ù„</option><option value="off">ØºÛŒØ±ÙØ¹Ø§Ù„</option></select>
      </div>
      <div class="col-span2"><label>Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</label>
        <div class="row">
          <label><input type="checkbox" id="notifyDue"> Ø§Ø¹Ù„Ø§Ù† Ù…ÙˆØ¹Ø¯ Ú†Ú©/Ù‚Ø³Ø·</label>
        </div>
      </div>
      <div class="col-span2"><label>Ø§Ù…Ù†ÛŒØª</label>
        <div class="grid g2">
          <div><input id="pinInput" placeholder="PIN 4-6 Ø±Ù‚Ù…ÛŒ"></div>
          <div><button id="btnSetPIN" class="btn">Ø«Ø¨Øª/ØªØºÛŒÛŒØ± PIN</button></div>
        </div>
      </div>
      <div class="col-span2"><label>Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÙ‡Ø§ (AES)</label>
        <div class="grid g2">
          <input id="encKey" placeholder="Ú©Ù„ÛŒØ¯ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ (Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±)">
          <button id="btnSetEnc" class="btn">Ø«Ø¨Øª Ú©Ù„ÛŒØ¯</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Ø¯ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒ</h3>
      <div class="row">
        <button id="btnSetPeriod" class="btn">ØªÙ†Ø¸ÛŒÙ… Ø¯ÙˆØ±Ù‡</button>
        <button id="btnClosePeriod" class="btn danger">Ø¨Ø³ØªÙ† Ø¯ÙˆØ±Ù‡</button>
      </div>
    </div>

    <div class="panel">
      <h3>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</h3>
      <div class="row small">
        <label><input type="checkbox" id="bkDaily"> Ø¨Ú©Ø§Ù¾ Ø±ÙˆØ²Ø§Ù†Ù‡ 23:59</label>
        <label><input type="checkbox" id="bkExit"> Ø¨Ú©Ø§Ù¾ Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÙˆØ¬</label>
        <label><input type="checkbox" id="bkMonthly"> Ø¨Ú©Ø§Ù¾ Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø¯Ùˆ Ù…Ø§Ù‡ Ø¢Ø®Ø±)</label>
      </div>
      <div class="grid g4">
        <div class="col-span2"><input id="cfUrl" placeholder="Cloudflare Worker URL (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></div>
        <div class="col-span2"><input id="cfSecret" placeholder="SECRET_KEY Base64 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="btnBackupNow" class="btn ok">Ø°Ø®ÛŒØ±Ù‡ Ø¨Ú©Ø§Ù¾ Ø¯Ø³ØªÛŒ</button>
        <input id="fileRestore" type="file" class="hidden" accept=".json,.zip,application/json">
        <button id="btnRestoreFile" class="btn">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² ÙØ§ÛŒÙ„</button>
      </div>
      <div id="bkLog" class="small"></div>
    </div>

    <div class="panel">
      <h3>Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…Ú©ÛŒ Ø´Ù†Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡</h3>
      <div id="smsPatternsBox" class="small">Ù‡Ù†ÙˆØ² Ø§Ù„Ú¯ÙˆÛŒÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡</div>
    </div>
  </section>
</main>
<footer></footer>
<script>
/* Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯ Ø¯Ø± Ø¨Ø®Ø´ Û²/Û³ Ùˆ Û³/Û³ Ù…ÛŒâ€ŒØ¢ÛŒØ¯ */
</script>
/************ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ************/
const DBKEY='VA_DB_v3';
const DEF_PERIOD='1404';
const $=q=>document.querySelector(q);
const $$=q=>document.querySelectorAll(q);
const fmt=n=>Number(n||0).toLocaleString('fa-IR');
const todayKey=()=>new Date().toISOString().slice(0,10);
const monthKey=()=>{const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');};
const cryptoRand = ()=> (crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2));

let DB = loadDB();

/* Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ */
function seedDB(){
  return {
    version:3,
    settings:{
      theme:'',
      voice:'on',
      period:DEF_PERIOD,
      notify:true,
      bkDaily:false, bkExit:true, bkMonthly:true,
      cfUrl:'', cfSecret:'',
      pin:'',
      encKey:'', // base64 Ú©Ù„ÛŒØ¯ Ù…Ø´ØªÙ‚ Ø´Ø¯Ù‡
      profile:'pro'
    },
    accounts:[
      {id:'1', level:1, name:'Ø¯Ø±Ø¢Ù…Ø¯Ù‡Ø§'},
      {id:'2', level:1, name:'Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§'},
      {id:'3', level:1, name:'ØµÙ†Ø¯ÙˆÙ‚'},
      {id:'4', level:1, name:'Ø¨Ø§Ù†Ú©â€ŒÙ‡Ø§'},
      {id:'5', level:1, name:'Ø§Ø´Ø®Ø§Øµ'},
      {id:'3.1', level:2, parent:'3', name:'ØµÙ†Ø¯ÙˆÙ‚ Ø¯Ø³ØªÛŒ'},
      {id:'4.1', level:2, parent:'4', name:'Ø¨Ø§Ù†Ú© Ø³Ø§Ù…Ø§Ù†'},
      {id:'2.1', level:2, parent:'2', name:'Ø®ÙˆØ±Ø§Ú©'},
      {id:'1.1', level:2, parent:'1', name:'ÙØ±ÙˆØ´'}
    ],
    tx:[], // {id,date,amount,from,to,method,note}
    cheques:[], // {id,kind:recv|pay, bank, number, amount, due, party, status:'inHand'|'paid'|'returned', period}
    inst:[], // {id,note,per,count,paid,next,done,period}
    building:{ items:[], units:[] }, // items: {id,name} , units:{id,bid,name,share}
    periods:{ [DEF_PERIOD]:true },
    backups:{daily:[], monthly:[], exit:[]},
    smsPatterns:{} // {'SENDER|Ú©Ù„Ù…Ù‡': {accTo:'2.1', sign:-1}}  sign: 1=income ,-1=expense
  };
}

/* Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ AES Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ Ùˆ Ø¨Ú©Ø§Ù¾ */
async function deriveKey(pass){
  const enc = new TextEncoder().encode(pass);
  const base = await crypto.subtle.importKey('raw', enc, 'PBKDF2',false, ['deriveKey']);
  return crypto.subtle.exportKey('raw', await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt:new TextEncoder().encode('va_salt'), iterations:100000, hash:'SHA-256'},
    base,{name:'AES-GCM', length:256},true,['encrypt','decrypt']
  )).then(b=>btoa(String.fromCharCode(...new Uint8Array(b))));
}
async function aesEncrypt(obj, b64Key){
  if(!b64Key) return {plain:true, data:obj};
  const keyRaw = Uint8Array.from(atob(b64Key),c=>c.charCodeAt(0));
  const key = await crypto.subtle.importKey('raw', keyRaw,'AES-GCM',false,['encrypt']);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, new TextEncoder().encode(JSON.stringify(obj)));
  return {plain:false, iv:Array.from(iv), blob:btoa(String.fromCharCode(...new Uint8Array(ct)))};
}
async function aesDecrypt(pack, b64Key){
  if(pack.plain) return pack.data;
  if(!b64Key) throw 'no key';
  const keyRaw = Uint8Array.from(atob(b64Key),c=>c.charCodeAt(0));
  const key = await crypto.subtle.importKey('raw', keyRaw,'AES-GCM',false,['decrypt']);
  const iv = new Uint8Array(pack.iv);
  const ct = Uint8Array.from(atob(pack.blob),c=>c.charCodeAt(0));
  const pt = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, ct);
  return JSON.parse(new TextDecoder().decode(pt));
}

/* Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ/Ø°Ø®ÛŒØ±Ù‡ */
function loadDB(){
  try{
    const raw = localStorage.getItem(DBKEY);
    if(!raw) return seedDB();
    const pack = JSON.parse(raw);
    if(pack && (pack.plain!==undefined || pack.blob)) {
      // Ù†Ø³Ø®Ù‡ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡
      return pack; // ÙØ¹Ù„Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ú©Ù„ÛŒØ¯ â€“ Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ù„ÛŒØ¯ØŒ Ø¯ÛŒÚ©Ø±ÛŒÙ¾Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    }
    return JSON.parse(raw);
  }catch(e){ console.error(e); return seedDB(); }
}
async function getDB(){
  // Ø§Ú¯Ø± Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ DB Ø¨Ù‡ Ø´Ú©Ù„ pack Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
  if(DB && DB.plain===false || DB.blob){
    try{
      const dec = await aesDecrypt(DB, (DB.settings?DB.settings.encKey:localStorage.getItem('VA_encKey')) || '');
      DB = dec;
      return DB;
    }catch(e){
      alert('Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ØŒ Ø§Ø¨ØªØ¯Ø§ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Â«Ú©Ù„ÛŒØ¯ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒÂ» Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      throw e;
    }
  }
  return DB;
}
function savePlain(obj){ localStorage.setItem(DBKEY, JSON.stringify(obj)); }
async function saveDB(){
  // Ø§Ú¯Ø± encKey ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ù…Ø² Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
  const encKey = DB.settings.encKey || localStorage.getItem('VA_encKey') || '';
  const pack = await aesEncrypt(DB, encKey);
  localStorage.setItem(DBKEY, JSON.stringify(pack));
}

/************ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ ************/
function setTheme(t){ document.body.classList.remove('theme-parmis','theme-modern','theme-dark'); if(t) document.body.classList.add(t); DB.settings.theme=t; saveDB(); }
function setVoiceMode(m){ DB.settings.voice=m; saveDB(); }
function setProfile(p){ DB.settings.profile=p; $('#profileSel').value=p; saveDB(); renderAll(); }
function ensureAccountOptions(){
  const fromSel=$('#txFrom'), toSel=$('#txTo');
  fromSel.innerHTML=''; toSel.innerHTML='';
  DB.accounts.forEach(a=>{
    const o1=document.createElement('option'); o1.value=a.id; o1.textContent=`${a.id} â€” ${a.name}`; fromSel.appendChild(o1);
    const o2=document.createElement('option'); o2.value=a.id; o2.textContent=`${a.id} â€” ${a.name}`; toSel.appendChild(o2);
  });
  // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  fromSel.value='3.1'; toSel.value='2.1';
}
function addTx({amount,from,to,method,note,sign}){
  const id=cryptoRand();
  DB.tx.push({id,date:new Date().toISOString(),amount:sign>0?Math.abs(+amount):-Math.abs(+amount),from,to,method,note});
}
function removeTx(id){ DB.tx=DB.tx.filter(t=>t.id!==id); }

/************ Ø¨Ú©Ø§Ù¾ ************/
function logBk(msg){ const el=$('#bkLog'); el.textContent='â€¢ '+msg; setTimeout(()=>el.textContent='',4000); }
function makePack(){ return {date:new Date().toISOString(), data:DB}; }
async function saveBackupLocal(kind){
  const pack = makePack();
  // Ø¨Ù‡ ØµÙˆØ±Øª ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ (iCloud/Files Ú©Ø§Ø±Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
  const blob = new Blob([JSON.stringify(pack)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  const name = kind==='monthly' ? `VA_Backup_Monthly_${monthKey()}` :
               kind==='exit' ? `VA_Backup_Exit_${todayKey()}` :
               `VA_Backup_Daily_${todayKey()}`;
  a.download = name+'.json'; a.click();
  DB.backups[kind] = DB.backups[kind]||[];
  DB.backups[kind].push({name, ts:Date.now()});
  // Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ: Ø±ÙˆØ²Ø§Ù†Ù‡ ÙÙ‚Ø· Û· ØªØ§ØŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ ÙÙ‚Ø· Û² ØªØ§
  if(kind==='daily' && DB.backups.daily.length>7) DB.backups.daily.splice(0, DB.backups.daily.length-7);
  if(kind==='monthly' && DB.backups.monthly.length>2) DB.backups.monthly.splice(0, DB.backups.monthly.length-2);
  await saveDB(); logBk('Backup saved: '+name);
}
async function sendBackupToCloudflare(pack){
  const url = $('#cfUrl').value.trim() || DB.settings.cfUrl || '';
  const secret = $('#cfSecret').value.trim() || DB.settings.cfSecret || '';
  if(!url) return {ok:false, error:'no_url'};
  try{
    const res = await fetch(url+'/backup',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:'me', period:DB.settings.period, dataJson:pack})});
    const j = await res.json(); return j;
  }catch(e){ return {ok:false, error:String(e)}; }
}
function scheduleBackups(){
  setInterval(async ()=>{
    const d=new Date(); const hh=d.getHours(), mm=d.getMinutes(), day=d.getDate();
    if(DB.settings.bkDaily && hh===23 && mm===59) await saveBackupLocal('daily');
    if(DB.settings.bkMonthly && day===1 && hh===0 && mm===0) await saveBackupLocal('monthly');
  }, 60000);
  document.addEventListener('visibilitychange', async ()=>{
    if(document.visibilityState==='hidden' && DB.settings.bkExit) await saveBackupLocal('exit');
  });
}

/************ Ù„Ø§Ú¯ÛŒÙ† PIN (Ø³Ø§Ø¯Ù‡) ************/
function askPINIfSet(){
  const pin=DB.settings.pin||'';
  if(!pin) return true;
  let t=prompt('PIN Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
  if(t===pin) return true;
  alert('Ù†Ø§Ø¯Ø±Ø³Øª'); return askPINIfSet();
}

/************ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ************/
async function init(){
  // Ø§Ú¯Ø± DB Ø±Ù…Ø²Ø¯Ø§Ø± Ø¯Ø± localStorage Ø¨ÙˆØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ Ø±Ø§ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª/Ù„ÙˆÚ©Ø§Ù„ Ø¨Ø®ÙˆØ§Ù†ÛŒÙ…:
  if(DB && DB.plain===false) {
    const k = localStorage.getItem('VA_encKey') || '';
    if(!k){ alert('Ú©Ù„ÛŒØ¯ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø´ÙˆØ¯.'); }
    else { DB = await aesDecrypt(DB, k); }
  }
  if(!DB || !DB.settings) DB = seedDB();
  setTheme(DB.settings.theme||'');
  $('#voiceMode').value=DB.settings.voice||'on';
  $('#themeSel').value=DB.settings.theme||'';
  $('#profileSel').value=DB.settings.profile||'pro';
  $('#periodLabel').textContent='Ø¯ÙˆØ±Ù‡ '+(DB.settings.period||DEF_PERIOD);
  ensureAccountOptions();
  renderAll();
  scheduleBackups();
  if(!askPINIfSet()) return;
}
document.addEventListener('DOMContentLoaded', init);
  /************ Ø±Ù†Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ùˆ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ ************/
function renderDash(){
  const today = new Date().toISOString().slice(0,10);
  const incToday = DB.tx.filter(t=>t.date.slice(0,10)===today && t.amount>0).reduce((s,t)=>s+t.amount,0);
  const expToday = DB.tx.filter(t=>t.date.slice(0,10)===today && t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0);
  const net = DB.tx.reduce((s,t)=>s+t.amount,0);
  $('#sumIncToday').textContent=fmt(incToday);
  $('#sumExpToday').textContent=fmt(expToday);
  $('#sumNet').textContent=fmt(net);
  // recent
  const UL=$('#recentList'); UL.innerHTML='';
  DB.tx.slice(-10).reverse().forEach(t=>{
    const li=document.createElement('li');
    li.innerHTML=`<span class="small">${t.note||''}</span><strong>${fmt(t.amount)}</strong>`;
    UL.appendChild(li);
  });
  drawCharts();
}
function renderTx(){
  const q = ($('#txSearch').value||'').trim();
  const f = $('#txFilter').value;
  const UL=$('#txList'); UL.innerHTML='';
  DB.tx.slice().reverse().filter(t=>{
    if(f==='inc' && t.amount<=0) return false;
    if(f==='exp' && t.amount>=0) return false;
    if(f==='tr'  && !(t.from&&t.to&&t.amount===0)){} // (Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ùˆ Ø«Ø¨Øª Ø¯Ø§Ø±Ø¯)
    if(!q) return true;
    return (t.note||'').includes(q);
  }).forEach(t=>{
    const li=document.createElement('li');
    const typ = t.amount>0?'ok':(t.amount<0?'danger':'');
    li.innerHTML=`<span class="small">${new Date(t.date).toLocaleDateString('fa-IR')} - ${t.note||''}</span>
                  <div><strong class="${typ}">${fmt(t.amount)}</strong> <button data-del="${t.id}" class="btn small">Ø­Ø°Ù</button></div>`;
    UL.appendChild(li);
  });
  UL.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{removeTx(b.dataset.del); saveDB(); renderAll();});
}
function buildTreeMap(){
  const map={};
  DB.accounts.forEach(a=>{
    if(a.parent){
      (map[a.parent]=map[a.parent]||{id:a.parent, children:[]});
      map[a.parent].children.push(a);
    }
  });
  return map;
}
function renderAccounts(){
  ensureAccountOptions();
  const UL=$('#accList'); UL.innerHTML='';
  DB.accounts.forEach(a=>{
    const li=document.createElement('li');
    li.innerHTML=`<div>${a.level} â€¢ ${a.id} â€” ${a.name}</div>
      <div class="row">
        <button class="btn small" data-edit="${a.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn small danger" data-del="${a.id}">Ø­Ø°Ù</button>
      </div>`;
    UL.appendChild(li);
  });
  UL.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
    const a=DB.accounts.find(x=>x.id===b.dataset.edit);
    const name=prompt('Ù†Ø§Ù… Ø­Ø³Ø§Ø¨:', a.name)||a.name;
    a.name=name; saveDB(); renderAccounts();
  });
  UL.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
    if(!confirm('Ø­Ø°Ù Ø­Ø³Ø§Ø¨ØŸ'))return;
    DB.accounts=DB.accounts.filter(x=>x.id!==b.dataset.del); saveDB(); renderAccounts();
  });
  // Ø¯Ø±Ø®Øª
  const tree=$('#accTree'); tree.innerHTML='';
  DB.accounts.filter(a=>!a.parent).forEach(root=>{
    const li=document.createElement('li');
    li.innerHTML=`<div>${root.name}</div>`;
    const sub=document.createElement('ul'); sub.className='list';
    DB.accounts.filter(a=>a.parent===root.id).forEach(ch=>{
      const li2=document.createElement('li'); li2.textContent=ch.name; sub.appendChild(li2);
    });
    li.appendChild(sub); tree.appendChild(li);
  });
}
function renderCheques(){
  const UL=$('#chList'); UL.innerHTML='';
  const kind=$('#chKind').value;
  DB.cheques.filter(c=>c.kind===kind).slice().reverse().forEach(c=>{
    const li=document.createElement('li');
    const status = {inHand:'Ù†Ø²Ø¯ ØµÙ†Ø¯ÙˆÙ‚', paid:'Ø®Ø±Ø¬/ÙˆØµÙˆÙ„ Ø´Ø¯Ù‡', returned:'Ø¨Ø±Ú¯Ø´ØªÛŒ'}[c.status]||c.status;
    li.innerHTML=`<div class="small">${c.bank} â€¢ ${c.number} â€¢ Ø³Ø±Ø±Ø³ÛŒØ¯: ${c.due} â€¢ ${c.party}</div>
      <div class="row"><strong>${fmt(c.amount)}</strong>
      <select data-st="${c.id}">
        <option value="inHand" ${c.status==='inHand'?'selected':''}>Ù†Ø²Ø¯ ØµÙ†Ø¯ÙˆÙ‚</option>
        <option value="paid" ${c.status==='paid'?'selected':''}>Ø®Ø±Ø¬/ÙˆØµÙˆÙ„</option>
        <option value="returned" ${c.status==='returned'?'selected':''}>Ø¨Ø±Ú¯Ø´ØªÛŒ</option>
      </select>
      <button class="btn small danger" data-del="${c.id}">Ø­Ø°Ù</button></div>`;
    UL.appendChild(li);
  });
  UL.querySelectorAll('[data-st]').forEach(s=>s.onchange=()=>{const c=DB.cheques.find(x=>x.id===s.dataset.st); c.status=s.value; saveDB();});
  UL.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{DB.cheques=DB.cheques.filter(x=>x.id!==b.dataset.del); saveDB(); renderCheques();});
}
function renderInst(){
  const UL=$('#insList'); UL.innerHTML='';
  DB.inst.filter(i=>i.period===DB.settings.period).slice().reverse().forEach(i=>{
    const li=document.createElement('li');
    li.innerHTML=`<div class="small">${i.note} | ${i.paid}/${i.count} | Ø¨Ø¹Ø¯ÛŒ: ${i.next||'-'}</div>
      <div class="row"><strong>${fmt(i.per)}</strong>
      <button class="btn small ok" data-pay="${i.id}">Ù¾Ø±Ø¯Ø§Ø®Øª</button>
      <button class="btn small danger" data-del="${i.id}">Ø­Ø°Ù</button></div>`;
    UL.appendChild(li);
  });
  UL.querySelectorAll('[data-pay]').forEach(b=>b.onclick=()=>{
    const i=DB.inst.find(x=>x.id===b.dataset.pay); if(!i) return;
    // Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒÚ© Ù‚Ø³Ø·:
    addTx({amount:i.per, from:'3.1', to:'2.1', method:'inst', note:'Ù‚Ø³Ø·: '+i.note, sign:-1});
    i.paid=(i.paid||0)+1;
    const d=i.next?new Date(i.next):new Date(); d.setMonth(d.getMonth()+1); i.next=d.toISOString().slice(0,10);
    if(i.paid>=i.count) i.done=true;
    saveDB(); renderInst(); renderDash(); renderTx();
  });
  UL.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{DB.inst=DB.inst.filter(x=>x.id!==b.dataset.del); saveDB(); renderInst();});
}
function renderBuilding(){
  const sel=$('#bSelect'); sel.innerHTML='';
  DB.building.items.forEach(b=>{const o=document.createElement('option');o.value=b.id;o.textContent=b.name; sel.appendChild(o);});
  if(DB.building.items.length===0){ DB.building.items.push({id:'b1',name:'Ø³Ø§Ø®ØªÙ…Ø§Ù† Û±'}); }
  if(!sel.value && DB.building.items[0]) sel.value=DB.building.items[0].id;
  const bid=sel.value;
  const UL=$('#bUnits'); UL.innerHTML='';
  DB.building.units.filter(u=>u.bid===bid).forEach(u=>{
    const li=document.createElement('li');
    li.innerHTML=`<div>${u.name} â€¢ Ø³Ù‡Ù… ${u.share||0}%</div>
      <div class="row"><button class="btn small" data-ed="${u.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
      <button class="btn small danger" data-del="${u.id}">Ø­Ø°Ù</button></div>`;
    UL.appendChild(li);
  });
  UL.querySelectorAll('[data-ed]').forEach(b=>b.onclick=()=>{
    const u=DB.building.units.find(x=>x.id===b.dataset.ed);
    u.name=prompt('Ù†Ø§Ù… ÙˆØ§Ø­Ø¯',u.name)||u.name; u.share=+prompt('Ø³Ù‡Ù… %',u.share)||u.share; saveDB(); renderBuilding();
  });
  UL.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{DB.building.units=DB.building.units.filter(x=>x.id!==b.dataset.del); saveDB(); renderBuilding();});
}
function drawCharts(){
  // Û³ Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±
  const months=[], inc=[], exp=[];
  for(let i=2;i>=0;i--){ const d=new Date(); d.setMonth(d.getMonth()-i); months.push(`${d.getFullYear()}/${d.getMonth()+1}`); inc.push(0); exp.push(0); }
  DB.tx.forEach(t=>{
    const d=new Date(t.date); const label=`${d.getFullYear()}/${d.getMonth()+1}`; const idx=months.indexOf(label);
    if(idx>=0){ if(t.amount>0) inc[idx]+=t.amount; else exp[idx]+=Math.abs(t.amount); }
  });
  const c1=$('#chartIE').getContext('2d');
  if(window._cIE) window._cIE.destroy();
  window._cIE=new Chart(c1,{type:'bar',data:{labels:months,datasets:[{label:'Ø¯Ø±Ø¢Ù…Ø¯',backgroundColor:'#10b981',data:inc},{label:'Ù‡Ø²ÛŒÙ†Ù‡',backgroundColor:'#ef4444',data:exp}]},options:{responsive:true,maintainAspectRatio:false}});
  // Ø³Ù‡Ù… Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§
  const accMap={};
  DB.accounts.forEach(a=>accMap[a.id]=0);
  DB.tx.forEach(t=>{ if(t.amount>0) accMap[t.to]+=t.amount; else accMap[t.from]+=Math.abs(t.amount); });
  const labels=Object.keys(accMap).map(k=> (DB.accounts.find(a=>a.id===k)||{}).name||k);
  const values=Object.values(accMap);
  const c2=$('#chartAccounts').getContext('2d');
  if(window._cAcc) window._cAcc.destroy();
  window._cAcc=new Chart(c2,{type:'pie',data:{labels, datasets:[{data:values}]} , options:{responsive:true,maintainAspectRatio:false}});
}

/************ Ù‡ÙˆØ´ ØµÙˆØªÛŒ + ØªØ¨Ø¯ÛŒÙ„ Ú¯ÙØªØ§Ø± Ø¨Ù‡ Ù…ØªÙ† ************/
function speak(txt){ try{ const u=new SpeechSynthesisUtterance(txt); u.lang='fa-IR'; speechSynthesis.speak(u);}catch{} }
function listenNoteOnce(targetInput){
  if($('#voiceMode').value==='off') return;
  try{
    const R=window.SpeechRecognition||window.webkitSpeechRecognition; if(!R) return alert('SpeechRecognition Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù†ÛŒØ³Øª');
    const r=new R(); r.lang='fa-IR'; r.interimResults=false; r.maxAlternatives=1; r.onresult=e=>{ targetInput.value=e.results[0][0].transcript; }; r.start();
  }catch(e){ alert('Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†'); }
}
$('#btnVoiceExplain').onclick=()=>listenNoteOnce($('#txNote'));

/************ Ù¾ÛŒØ§Ù…Ú© Ø¨Ø§Ù†Ú©ÛŒ â€” Ø§ÙØ²ÙˆØ¯Ù† Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ ************/
function parseSms(text){
  // Ø³Ø§Ø¯Ù‡: Ù…Ø¨Ù„Øº + Ù†Ø´Ø§Ù†Ù‡ ÙˆØ§Ø±ÛŒØ²/Ø¨Ø±Ø¯Ø§Ø´Øª + Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡
  const num = (text.match(/([\d,]+)\s*Ø±ÛŒØ§Ù„|([\d,]+)\s*ØªÙˆÙ…Ø§Ù†/g)||[]).pop()||'0';
  let amount = +num.replace(/[^\d]/g,'');
  if(/ØªÙˆÙ…Ø§Ù†/.test(num)) amount*=10; // ØªÙ‚Ø±ÛŒØ¨ÛŒ
  let sign = /ÙˆØ§Ø±ÛŒØ²|ÙˆØµÙˆÙ„|Ø¯Ø±ÛŒØ§ÙØª/.test(text)? +1 : -1;
  // ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ
  let accTo='2.1';
  for(const k in DB.smsPatterns){
    if(text.includes(k.split('|')[1])){ const P=DB.smsPatterns[k]; accTo=P.accTo; sign=P.sign; break; }
  }
  return {amount, sign, accTo, raw:text};
}
function importFromSMS(){
  const raw = prompt('Ù…ØªÙ† Ù¾ÛŒØ§Ù…Ú© Ø¨Ø§Ù†Ú©ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†:','');
  if(!raw) return;
  const p=parseSms(raw);
  const ok = confirm(`ØªØ´Ø®ÛŒØµ: Ù…Ø¨Ù„Øº ${fmt(p.amount)} | Ù†ÙˆØ¹: ${p.sign>0?'Ø¯Ø±ÛŒØ§ÙØª':'Ù¾Ø±Ø¯Ø§Ø®Øª'} | Ø³Ø±ÙØµÙ„: ${p.accTo}\nØªØ£ÛŒÛŒØ¯ØŸ`);
  if(!ok) return;
  if(p.sign>0) addTx({amount:p.amount, from:'5', to:p.accTo, method:'cash', note:'Ø§Ø² Ù¾ÛŒØ§Ù…Ú©: Ø¯Ø±ÛŒØ§ÙØª', sign:+1});
  else addTx({amount:p.amount, from:p.accTo, to:'3.1', method:'cash', note:'Ø§Ø² Ù¾ÛŒØ§Ù…Ú©: Ù¾Ø±Ø¯Ø§Ø®Øª', sign:-1});
  // ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡
  const kw = prompt('ÛŒÚ© Ú©Ù„Ù…Ù‡â€ŒÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø§Ø² Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ "Ø´Ø§Ø±Ú˜ Ø§ÛŒØ±Ø§Ù†Ø³Ù„") ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±:','')||'';
  if(kw){
    DB.smsPatterns['BANK|'+kw]={accTo:p.accTo, sign:p.sign};
  }
  saveDB(); renderAll();
}
$('#btnImportSMS').onclick=importFromSMS;

/************ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ (Ù…Ø­Ù„ÛŒ) ************/
async function notify(txt){
  try{
    if(Notification && (await Notification.requestPermission())==='granted'){
      new Notification('Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±', {body:txt});
    }else alert(txt);
  }catch{ alert(txt); }
}
function scanDue(){
  // Ú†Ú©/Ù‚Ø³Ø· Ú©Ù‡ ØªØ§ Û³ Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ø³Ø±Ø±Ø³ÛŒØ¯ Ø¯Ø§Ø±Ù†Ø¯
  const now=new Date(); const soon=new Date(); soon.setDate(now.getDate()+3);
  const dueCheques = DB.cheques.filter(c=>c.status==='inHand' && new Date(c.due)<=soon);
  const dueInst = DB.inst.filter(i=>!i.done && new Date(i.next)<=soon);
  if(dueCheques.length) notify(`Ù…ÙˆØ¹Ø¯ Ú†Ú©: ${dueCheques.length} Ù…ÙˆØ±Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ø§Ø³Øª`);
  if(dueInst.length) notify(`Ù…ÙˆØ¹Ø¯ Ù‚Ø³Ø·: ${dueInst.length} Ù…ÙˆØ±Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ø§Ø³Øª`);
}
setInterval(scanDue, 60*60*1000);

/************ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ UI ************/
function showTab(name){ $$('.view').forEach(v=>v.classList.add('hidden')); $('#view-'+name).classList.remove('hidden'); $$('.navlink').forEach(n=>n.classList.remove('active')); document.querySelector(`.navlink[data-tab="${name}"]`).classList.add('active'); }
$('#btnMenu').onclick=()=>$('#drawer').classList.add('show');
$('#btnCloseDrawer').onclick=()=>$('#drawer').classList.remove('show');
$$('.navlink').forEach(n=>n.onclick=()=>{showTab(n.dataset.tab); $('#drawer').classList.remove('show');});

$('#btnAddIncome').onclick=()=>{ $('#txTo').value='1.1'; $('#txMethod').value='cash'; $('#txAmount').focus(); };
$('#btnAddExpense').onclick=()=>{ $('#txFrom').value='2.1'; $('#txMethod').value='cash'; $('#txAmount').focus(); };
$('#btnTransfer').onclick=()=>{ $('#txMethod').value='cash'; $('#txAmount').focus(); };

$('#btnSaveIncome').onclick=async ()=>{
  const amount=+$('#txAmount').value||0; if(!amount) return;
  addTx({amount, from:$('#txFrom').value, to:$('#txTo').value, method:$('#txMethod').value, note:$('#txNote').value, sign:+1});
  await saveDB(); renderAll(); speak('Ø¯Ø±ÛŒØ§ÙØª Ø«Ø¨Øª Ø´Ø¯');
};
$('#btnSaveExpense').onclick=async ()=>{
  const amount=+$('#txAmount').value||0; if(!amount) return;
  addTx({amount, from:$('#txFrom').value, to:$('#txTo').value, method:$('#txMethod').value, note:$('#txNote').value, sign:-1});
  await saveDB(); renderAll(); speak('Ù¾Ø±Ø¯Ø§Ø®Øª Ø«Ø¨Øª Ø´Ø¯');
};
$('#btnSaveTransfer').onclick=async ()=>{
  const amount=+$('#txAmount').value||0; if(!amount) return;
  // Ø§Ù†ØªÙ‚Ø§Ù„ = ÛŒÚ© Ø®Ø±ÙˆØ¬ÛŒ Ùˆ ÛŒÚ© ÙˆØ±ÙˆØ¯ÛŒ
  addTx({amount, from:$('#txFrom').value, to:'', method:'transfer', note:'Ø§Ù†ØªÙ‚Ø§Ù„: '+$('#txNote').value, sign:-1});
  addTx({amount, from:'', to:$('#txTo').value, method:'transfer', note:'Ø§Ù†ØªÙ‚Ø§Ù„: '+$('#txNote').value, sign:+1});
  await saveDB(); renderAll(); speak('Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
};

$('#txSearch').oninput=renderTx; $('#txFilter').onchange=renderTx;

$('#btnAccAdd').onclick=()=>{ const id=prompt('Ú©Ø¯ Ø­Ø³Ø§Ø¨ (Ù…Ø«Ù„ 2.3 ÛŒØ§ 6):'); if(!id) return; const name=prompt('Ù†Ø§Ù… Ø­Ø³Ø§Ø¨:'); const level=(id.split('.').length); const parent = id.includes('.')? id.split('.').slice(0,-1).join('.') : ''; DB.accounts.push({id,name,level,parent}); saveDB(); renderAccounts(); };
$('#btnAccTree').onclick=()=>$('#accTreePanel').classList.toggle('hidden');

$('#btnAddCheque').onclick=()=>{
  const c={id:cryptoRand(),kind:$('#chKind').value, bank:prompt('Ø¨Ø§Ù†Ú©ØŸ','Ù…Ù„ÛŒ')||'â€”', number:prompt('Ø´Ù…Ø§Ø±Ù‡ Ú†Ú©ØŸ','')||'', amount:+prompt('Ù…Ø¨Ù„ØºØŸ','0')||0, due:prompt('ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ØŸ','1404-12-29')||'', party:prompt('Ø¯Ø±ÛŒØ§ÙØª Ø§Ø²/Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ØŸ','')||'', status:'inHand', period:DB.settings.period};
  DB.cheques.push(c); saveDB(); renderCheques();
};

$('#btnAddInst').onclick=()=>{
  const i={id:cryptoRand(), note:$('#insNote').value, per:+$('#insPer').value||0, count:+$('#insCount').value||0, paid:0, next:$('#insNext').value||todayKey(), done:false, period:DB.settings.period};
  if(!i.per||!i.count) return alert('Ù…Ø¨Ù„Øº/ØªØ¹Ø¯Ø§Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
  DB.inst.push(i); saveDB(); renderInst();
};

$('#bSelect').onchange=renderBuilding;
$('#btnBAdd').onclick=()=>{ const name=prompt('Ù†Ø§Ù… Ø³Ø§Ø®ØªÙ…Ø§Ù†/Ù…Ø¬ØªÙ…Ø¹ØŸ','Ø³Ø§Ø®ØªÙ…Ø§Ù† Ø¬Ø¯ÛŒØ¯'); if(!name) return; DB.building.items.push({id:cryptoRand(),name}); saveDB(); renderBuilding(); };
$('#btnBAddUnit').onclick=()=>{ const bid=$('#bSelect').value; const name=$('#bUnitName').value.trim(); const share=+$('#bUnitShare').value||0; if(!name) return; DB.building.units.push({id:cryptoRand(),bid,name,share}); saveDB(); renderBuilding(); };
$('#btnBSplit').onclick=()=>{
  const bid=$('#bSelect').value; const units=DB.building.units.filter(u=>u.bid===bid);
  const tot=+$('#bCostTotal').value||0; const note=$('#bCostNote').value||'Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø´ØªØ±Ú©';
  const sumShare = units.reduce((s,u)=>s+(+u.share||0),0)||100;
  const UL=$('#bSplitList'); UL.innerHTML='';
  units.forEach(u=>{
    const part = Math.round(tot*(u.share||0)/sumShare);
    const li=document.createElement('li'); li.innerHTML=`<div>${u.name}</div><strong>${fmt(part)}</strong>`; UL.appendChild(li);
    // Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ø± ÙˆØ§Ø­Ø¯ (Ø¯Ø± Ø­Ø§Ù„Øª Lite ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´Ø› Ø¯Ø± Ø­Ø§Ù„Øª Pro Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´)
    if(DB.settings.profile==='pro'){
      addTx({amount:part, from:'3.1', to:'2.1', method:'cash', note:`${note} - ${u.name}`, sign:-1});
    }
  });
  saveDB(); renderAll();
};

/************ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ************/
$('#themeSel').onchange=()=>setTheme($('#themeSel').value);
$('#voiceMode').onchange=()=>{setVoiceMode($('#voiceMode').value); saveDB();}
$('#profileSel').onchange=()=>setProfile($('#profileSel').value);
$('#notifyDue').checked=true;
$('#btnSetPeriod').onclick=()=>{ const p=prompt('Ø¹Ø¯Ø¯ Ø¯ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒ (Ù…Ø«Ù„Ø§Ù‹ 1404):', DB.settings.period)||DB.settings.period; DB.settings.period=p; DB.periods[p]=true; saveDB(); $('#periodLabel').textContent='Ø¯ÙˆØ±Ù‡ '+p; };
$('#btnClosePeriod').onclick=()=>{ if(confirm('Ø¨Ø³ØªÙ† Ø¯ÙˆØ±Ù‡ Ùˆ Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÛŒØ¯ØŸ')){ const np=String((+DB.settings.period||1404)+1); DB.settings.period=np; DB.periods[np]=true; saveDB(); $('#periodLabel').textContent='Ø¯ÙˆØ±Ù‡ '+np; } };
$('#btnSetPIN').onclick=()=>{ DB.settings.pin=$('#pinInput').value||''; saveDB(); alert('PIN Ø«Ø¨Øª Ø´Ø¯'); };
$('#btnSetEnc').onclick=async ()=>{ const pass=$('#encKey').value||''; if(!pass){ DB.settings.encKey=''; localStorage.removeItem('VA_encKey'); await saveDB(); return alert('Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯'); } const k=await deriveKey(pass); DB.settings.encKey=k; localStorage.setItem('VA_encKey',k); await saveDB(); alert('Ú©Ù„ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÙ‡Ø§ Ø±Ù…Ø² Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)'); };
$('#bkDaily').onchange=()=>{ DB.settings.bkDaily=$('#bkDaily').checked; saveDB(); };
$('#bkExit').onchange=()=>{ DB.settings.bkExit=$('#bkExit').checked; saveDB(); };
$('#bkMonthly').onchange=()=>{ DB.settings.bkMonthly=$('#bkMonthly').checked; saveDB(); };
$('#cfUrl').oninput=()=>{ DB.settings.cfUrl=$('#cfUrl').value.trim(); saveDB(); };
$('#cfSecret').oninput=()=>{ DB.settings.cfSecret=$('#cfSecret').value.trim(); saveDB(); };
$('#btnBackupNow').onclick=()=>saveBackupLocal('daily');
$('#btnRestoreFile').onclick=()=>$('#fileRestore').click();
$('#fileRestore').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text(); const pack=JSON.parse(txt);
  if(!pack.data) return alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
  if(!confirm('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ØŸ')) return;
  DB=pack.data; await saveDB(); location.reload();
};

/************ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ************/
$('#toolCalc').onclick=()=>{ const v=prompt('Ø­Ø³Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ 2*3+5):',''); if(!v) return; try{$('#toolsArea').textContent='= '+Intl.NumberFormat('fa-IR').format(Function('return '+v)());}catch{$('#toolsArea').textContent='ÙØ±Ù…ÙˆÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±';}};
$('#toolFx').onclick=()=>{ const r=+prompt('Ù†Ø±Ø® Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†):','0')||0; const a=+prompt('Ù…Ø¨Ù„Øº Ø¯Ù„Ø§Ø±:','0')||0; $('#toolsArea').textContent=Intl.NumberFormat('fa-IR').format(r*a)+' ØªÙˆÙ…Ø§Ù†'; };
$('#toolNote').onclick=()=>{ const t=prompt('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:',''); if(t) $('#toolsArea').textContent='ÛŒØ§Ø¯Ø¯Ø§Ø´Øª: '+t; };

/************ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ ************/
function renderReports(){
  const income = DB.tx.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0);
  const expense = DB.tx.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0);
  const net = income-expense;
  $('#reportSummary').innerHTML = `
    Ø¬Ù…Ø¹ Ø¯Ø±Ø¢Ù…Ø¯: <strong>${fmt(income)}</strong> â€” 
    Ø¬Ù…Ø¹ Ù‡Ø²ÛŒÙ†Ù‡: <strong>${fmt(expense)}</strong> â€” 
    Ø®Ø§Ù„Øµ: <strong>${fmt(net)}</strong>`;
  // Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚ØµØ¯/Ù…Ø¨Ø¯Ø£
  const accMap={};
  DB.accounts.forEach(a=>accMap[a.id]=0);
  DB.tx.forEach(t=>{ if(t.amount>0) accMap[t.to]+=t.amount; else accMap[t.from]+=Math.abs(t.amount); });
  const labels=Object.keys(accMap).map(k=> (DB.accounts.find(a=>a.id===k)||{}).name||k);
  const values=Object.values(accMap);
  const ctx=$('#chartByAccount').getContext('2d');
  if(window._cBA) window._cBA.destroy();
  window._cBA=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ù…Ø¨Ø§Ù„Øº',data:values, backgroundColor:'#0b9981'}]},options:{responsive:true,maintainAspectRatio:false}});
}
$('#btnExportJSON').onclick=()=>{ const blob=new Blob([JSON.stringify(DB)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='VA_DB.json'; a.click(); };
$('#btnExportCSV').onclick=()=>{ const rows=[['date','amount','from','to','method','note']]; DB.tx.forEach(t=>rows.push([t.date,t.amount,t.from,t.to,t.method,(t.note||'').replace(/\n/g,' ')])); const csv=rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='VA_DB.csv'; a.click(); };
$('#btnExportPDF').onclick=()=>{ window.print(); };

/************ Ø±Ù†Ø¯Ø± Ú©Ù„ÛŒ ************/
function renderAll(){
  renderDash(); renderTx(); renderAccounts(); renderCheques(); renderInst(); renderBuilding(); renderReports();
  // Ù†Ù…Ø§ÛŒØ´ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…Ú©ÛŒ
  const box=$('#smsPatternsBox'); const keys=Object.keys(DB.smsPatterns); if(keys.length===0) box.textContent='Ù‡Ù†ÙˆØ² Ø§Ù„Ú¯ÙˆÛŒÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡'; else box.innerHTML=keys.map(k=>`<div>â€¢ ${k} => ${(DB.smsPatterns[k].sign>0?'Ø¯Ø±ÛŒØ§ÙØª':'Ù¾Ø±Ø¯Ø§Ø®Øª')} â†’ ${DB.smsPatterns[k].accTo}</div>`).join('');
}

/* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ù‡Ø¯Ø± */
$('#btnBackup').onclick=()=>saveBackupLocal('daily');
$('#btnVoice').onclick=()=>alert('Ø­Ø§Ù„Øª ØµÙˆØªÛŒ '+(DB.settings.voice==='on'?'ÙØ¹Ø§Ù„':'ØºÛŒØ±ÙØ¹Ø§Ù„'));

/* Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ */
showTab('dashboard');
</script>
</body>
</html>
