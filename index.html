<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mia AI – دستیار حسابداری هوشمند</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --color-bg: #f7f7f7;
  --color-text: #222;
  --color-primary: #4a90e2;
  --color-card: #fff;
  --color-border: #ccc;
}
body.dark {
  --color-bg: #1c1c1e;
  --color-text: #eee;
  --color-card: #2c2c2e;
  --color-border: #444;
}
body.parmis {
  --color-bg: #eaf2f8;
  --color-text: #2e4053;
  --color-primary: #2874a6;
}
body.modern {
  --color-bg: #ffffff;
  --color-text: #111;
  --color-primary: #6c63ff;
  --color-card: #fafafa;
}

body {
  font-family: "Vazirmatn", sans-serif;
  background: var(--color-bg);
  color: var(--color-text);
  margin: 0;
  padding: 0;
  transition: background 0.3s, color 0.3s;
}

header {
  background: var(--color-primary);
  color: white;
  padding: 1rem;
  text-align: center;
  font-weight: bold;
  font-size: 1.2rem;
  border-bottom: 3px solid var(--color-border);
}

nav {
  display: flex;
  justify-content: space-around;
  background: var(--color-card);
  border-top: 1px solid var(--color-border);
  border-bottom: 1px solid var(--color-border);
  padding: 0.5rem 0;
}

nav button {
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  color: var(--color-primary);
}

section {
  padding: 1rem;
}

.card {
  background: var(--color-card);
  border: 1px solid var(--color-border);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
}

input, select, button, textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--color-border);
  border-radius: 6px;
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

button.primary {
  background: var(--color-primary);
  color: white;
  border: none;
  cursor: pointer;
}

.chart-container {
  width: 100%;
  height: 250px;
}

.hidden {
  display: none;
}
</style>
</head>

<body class="parmis">
<header>📊 Mia AI – حسابدار هوشمند</header>

<nav>
  <button onclick="showSection('dashboard')">خانه</button>
  <button onclick="showSection('transactions')">تراکنش‌ها</button>
  <button onclick="showSection('reports')">گزارش</button>
  <button onclick="showSection('voice')">🎤 صوتی</button>
  <button onclick="showSection('settings')">⚙️ تنظیمات</button>
</nav>

<main>
  <!-- بخش داشبورد -->
  <section id="dashboard" class="card">
    <h3>خلاصه حساب</h3>
    <p>درآمد کل: <span id="totalIncome">۰</span> تومان</p>
    <p>هزینه کل: <span id="totalExpense">۰</span> تومان</p>
    <p>مانده: <span id="balance">۰</span> تومان</p>
  </section>

  <!-- بخش تراکنش‌ها -->
  <section id="transactions" class="card hidden">
    <h3>افزودن تراکنش</h3>
    <select id="type">
      <option value="income">درآمد</option>
      <option value="expense">هزینه</option>
      <option value="transfer">انتقال</option>
    </select>
    <input type="text" id="desc" placeholder="توضیح (مثلاً فروش کالا)">
    <input type="number" id="amount" placeholder="مبلغ">
    <button class="primary" onclick="addTransaction()">ذخیره تراکنش</button>

    <h4>لیست تراکنش‌ها</h4>
    <div id="txList"></div>
  </section>
    <!-- بخش گزارش‌ها -->
  <section id="reports" class="card hidden">
    <h3>گزارش‌های گرافیکی</h3>
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
    <button class="primary" onclick="generateChart()">نمایش نمودار</button>
  </section>

  <!-- بخش هوش صوتی -->
  <section id="voice" class="card hidden">
    <h3>دستیار صوتی</h3>
    <p>برای افزودن تراکنش با صدا بگو:  
    <b>«درآمد امروز پنج میلیون از فروش»</b></p>
    <button id="startVoice" class="primary">🎤 شروع گوش دادن</button>
    <p id="voiceText"></p>
  </section>

  <!-- بخش تنظیمات -->
  <section id="settings" class="card hidden">
    <h3>تنظیمات</h3>
    <label>انتخاب تم:</label>
    <select id="themeSelect" onchange="changeTheme(this.value)">
      <option value="parmis">پارمیس</option>
      <option value="dark">تیره</option>
      <option value="modern">مدرن</option>
      <option value="light">روشن</option>
    </select>

    <label>بکاپ داده‌ها</label>
    <button onclick="backupData()">📦 تهیه نسخه پشتیبان</button>

    <label>بازیابی داده‌ها</label>
    <input type="file" id="restoreFile" onchange="restoreData(event)">

    <h4>رمزگذاری (AES)</h4>
    <input type="password" id="aesKey" placeholder="کلید رمزگذاری">
    <button class="primary" onclick="encryptData()">رمزگذاری داده‌ها</button>
  </section>
</main>

<script>
// ------------------------------
// 🔹 مدیریت بخش‌ها
// ------------------------------
function showSection(id) {
  document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// ------------------------------
// 🔹 داده‌ها و تراکنش‌ها
// ------------------------------
let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

function addTransaction() {
  const type = document.getElementById('type').value;
  const desc = document.getElementById('desc').value;
  const amount = parseFloat(document.getElementById('amount').value);

  if (!desc || !amount) return alert("توضیح و مبلغ را وارد کنید");

  transactions.push({ type, desc, amount, date: new Date().toLocaleDateString('fa-IR') });
  localStorage.setItem('transactions', JSON.stringify(transactions));
  updateDashboard();
  renderList();
  alert("✅ تراکنش ثبت شد");
  document.getElementById('desc').value = '';
  document.getElementById('amount').value = '';
}

function renderList() {
  const list = document.getElementById('txList');
  list.innerHTML = transactions.map(t =>
    `<div class="card">
      <b>${t.type === 'income' ? '💰 درآمد' : t.type === 'expense' ? '💸 هزینه' : '🔁 انتقال'}</b>
      <p>${t.desc}</p>
      <p>${t.amount.toLocaleString()} تومان</p>
      <small>${t.date}</small>
    </div>`
  ).join('');
}

function updateDashboard() {
  let income = transactions.filter(t => t.type === 'income').reduce((a,b)=>a+b.amount,0);
  let expense = transactions.filter(t => t.type === 'expense').reduce((a,b)=>a+b.amount,0);
  document.getElementById('totalIncome').textContent = income.toLocaleString();
  document.getElementById('totalExpense').textContent = expense.toLocaleString();
  document.getElementById('balance').textContent = (income - expense).toLocaleString();
}
updateDashboard();
renderList();

// ------------------------------
// 📊 گزارش‌ها
// ------------------------------
function generateChart() {
  const ctx = document.getElementById('chart');
  const income = transactions.filter(t => t.type === 'income').reduce((a,b)=>a+b.amount,0);
  const expense = transactions.filter(t => t.type === 'expense').reduce((a,b)=>a+b.amount,0);
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['درآمد', 'هزینه'],
      datasets: [{
        data: [income, expense],
        borderWidth: 1
      }]
    }
  });
}

// ------------------------------
// 🎤 هوش صوتی (SpeechRecognition)
// ------------------------------
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognizer = new SpeechRecognition();
  recognizer.lang = 'fa-IR';
  recognizer.continuous = false;

  document.getElementById('startVoice').onclick = () => {
    recognizer.start();
    document.getElementById('voiceText').textContent = "در حال گوش دادن...";
  };

  recognizer.onresult = (event) => {
    const text = event.results[0][0].transcript;
    document.getElementById('voiceText').textContent = text;
    parseVoiceCommand(text);
  };
}

function parseVoiceCommand(text) {
  if (text.includes('درآمد')) {
    let amount = extractNumber(text);
    transactions.push({type: 'income', desc: 'درآمد صوتی', amount});
  } else if (text.includes('هزینه')) {
    let amount = extractNumber(text);
    transactions.push({type: 'expense', desc: 'هزینه صوتی', amount});
  }
  localStorage.setItem('transactions', JSON.stringify(transactions));
  updateDashboard();
  renderList();
}

function extractNumber(text) {
  const match = text.match(/\d+/g);
  return match ? parseInt(match.join('')) : 0;
}
  // ------------------------------
// 🔒 رمزگذاری داده‌ها (AES)
// ------------------------------
async function encryptData() {
  const keyText = document.getElementById('aesKey').value;
  if (!keyText) return alert('کلید رمزگذاری را وارد کنید');
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw', enc.encode(keyText), 'AES-GCM', false, ['encrypt']
  );
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = JSON.stringify(transactions);
  const encrypted = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv }, key, enc.encode(data)
  );
  const blob = new Blob([iv, new Uint8Array(encrypted)], { type: 'application/octet-stream' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'backup_encrypted.dat';
  link.click();
  alert('✅ داده‌ها رمزگذاری و دانلود شدند.');
}

// ------------------------------
// ☁️ بکاپ و بازیابی داده‌ها
// ------------------------------
function backupData() {
  const blob = new Blob([JSON.stringify(transactions, null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'backup_miaai.json';
  link.click();
  alert('📦 نسخه پشتیبان آماده است.');
}

function restoreData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    transactions = JSON.parse(e.target.result);
    localStorage.setItem('transactions', JSON.stringify(transactions));
    updateDashboard();
    renderList();
    alert('✅ داده‌ها با موفقیت بازیابی شدند.');
  };
  reader.readAsText(file);
}

// ------------------------------
// 🔔 اعلان‌ها (Notifications)
// ------------------------------
if ('Notification' in window) {
  Notification.requestPermission().then(p => {
    if (p === 'granted') {
      scheduleReminders();
    }
  });
}

function scheduleReminders() {
  setTimeout(() => {
    new Notification('🔔 یادآوری Mia AI', {
      body: 'سررسید اقساط یا چک‌های خود را بررسی کنید 💳',
      icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'
    });
  }, 10000); // نمایش اعلان پس از ۱۰ ثانیه به عنوان نمونه
}

// ------------------------------
// 🎨 تغییر تم‌ها
// ------------------------------
function changeTheme(theme) {
  document.body.className = theme === 'light' ? '' : theme;
  localStorage.setItem('theme', theme);
}
const savedTheme = localStorage.getItem('theme');
if (savedTheme) changeTheme(savedTheme);

// ------------------------------
// 🕓 بکاپ خودکار زمان خروج
// ------------------------------
window.addEventListener('beforeunload', () => {
  localStorage.setItem('transactions', JSON.stringify(transactions));
});

// ------------------------------
// 🧮 ماشین حساب داخلی (ساده)
// ------------------------------
function quickCalc(expression) {
  try { return eval(expression); }
  catch { return 'خطا'; }
}

// ------------------------------
// پایان
// ------------------------------
</script>

<footer style="text-align:center;padding:1rem;font-size:0.8rem;color:gray;">
  Mia AI © 2025 — نسخه فاز دوم
</footer>

</body>
</html>
