<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± ØµÙˆØªÛŒ</title>
<meta name="theme-color" content="#0e7c86"/>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<style>
:root{--teal:#0e7c86;--soft:#f4f7f9;--card:#fff;--line:#e6eef2}
*{box-sizing:border-box} body{margin:0;background:var(--soft);font-family:Tahoma,system-ui}
header{background:var(--teal);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
h1{margin:0;font-size:18px} .sub{opacity:.9;font-size:12px}
main{padding:12px 16px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 14px;font-size:14px;background:#e0f2f1;color:#064a50}
.btn.primary{background:#0e7c86;color:#fff} .btn.danger{background:#933;color:#fff}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
.grid{display:grid;gap:8px} .g3{grid-template-columns:repeat(3,1fr)}
.val{font-weight:700;color:#0a7f2e}
.list{list-style:none;margin:0;padding:0} .list li{border:1px solid var(--line);background:#fff;border-radius:10px;margin:6px 0;padding:10px;display:flex;justify-content:space-between;align-items:center}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cfe6ff;background:#eef6ff;color:#0a4a7c}
.negative{color:#b20000}.positive{color:#0a7f2e}
label{font-size:13px;display:block;margin:6px 0 2px} input,select{width:100%;padding:10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff}
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);align-items:center;justify-content:center}
.modal .box{width:min(520px,92vw);background:#fff;border-radius:14px;padding:14px}
.modal.show{display:flex}
.tabbar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.tabbar .tab{background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer}
.tabbar .tab.active{background:#0e7c86;color:#fff;border-color:#0e7c86}
footer{padding:24px 0 10px;color:#666;font-size:12px;text-align:center}
.small{font-size:12px;color:#6b7280}
.hidden{display:none}
</style>
</head>
<body>
<header>
  <div>
    <h1>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± ØµÙˆØªÛŒ</h1>
    <div class="sub" id="pwaState">PWA</div>
  </div>
  <div class="row">
    <button id="btnStart" class="btn primary">ğŸ™ï¸ Ø´Ø±ÙˆØ¹</button>
    <button id="btnStop" class="btn danger">â¹ ØªÙˆÙ‚Ù</button>
    <button id="btnSetup" class="btn">âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡</button>
    <button id="btnExport" class="btn">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
    <button id="btnImport" class="btn">ğŸ“¥ ÙˆØ±ÙˆØ¯ JSON</button>
    <button id="btnNotify" class="btn">ğŸ”” ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†</button>
  </div>
</header>

<main>
  <div class="tabbar">
    <div class="tab active" data-tab="dashboard">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
    <div class="tab" data-tab="transactions">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
    <div class="tab" data-tab="checks">Ú†Ú©â€ŒÙ‡Ø§</div>
    <div class="tab" data-tab="inst">Ø§Ù‚Ø³Ø§Ø·</div>
    <div class="tab" data-tab="people">Ø§Ø´Ø®Ø§Øµ</div>
    <div class="tab" data-tab="accounts">Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</div>
  </div>

  <!-- Dashboard -->
  <section id="tab-dashboard">
    <div class="card">
      <div class="grid g3">
        <div><div>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø§Ù„Øµ</div><div id="netWorth" class="val">â€”</div></div>
        <div><div>Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²</div><div id="todayIncome" class="val">â€”</div></div>
        <div><div>Ø®Ø±Ø¬ Ø§Ù…Ø±ÙˆØ²</div><div id="todayExpense" class="val">â€”</div></div>
      </div>
    </div>
    <div class="card">
      <div class="row">
        <button class="btn" data-quick="say-exp">+ Ø®Ø±Ø¬</button>
        <button class="btn" data-quick="say-inc">+ ÙˆØ§Ø±ÛŒØ²</button>
        <button class="btn" data-quick="add-check">+ Ú†Ú©</button>
        <button class="btn" data-quick="add-inst">+ Ù‚Ø³Ø·</button>
      </div>
      <div class="small">Ù…Ø«Ø§Ù„ Ø¨Ú¯Ùˆ: Â«Û³Û°Û° Ù‡Ø²Ø§Ø± Ø®Ø±Ø¬ Ú©Ø±Ø¯Ù… Ø¨Ù†Ø²ÛŒÙ†Â» ÛŒØ§ Â«Û² Ù…ÛŒÙ„ÛŒÙˆÙ† Ú¯Ø±ÙØªÙ… Ø¨Ø§Ø¨Øª Ú©Ø§Ø±Â»</div>
    </div>
    <div class="card">
      <h3>ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
      <ul id="txList" class="list"></ul>
    </div>
  </section>

  <!-- Transactions -->
  <section id="tab-transactions" class="hidden">
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label>ØªÙˆØ¶ÛŒØ­</label><input id="txNote" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø®Ø±ÛŒØ¯ Ø³ÙˆÙ¾Ø±">
        </div>
        <div style="width:160px">
          <label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label><input id="txAmount" inputmode="numeric" placeholder="300000">
        </div>
        <div style="width:140px">
          <label>Ù†ÙˆØ¹</label>
          <select id="txType"><option value="expense">Ø®Ø±Ø¬</option><option value="income">ÙˆØ§Ø±ÛŒØ²</option></select>
        </div>
      </div>
      <div class="row"><button id="btnAddTx" class="btn primary">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button></div>
    </div>
    <div class="card">
      <ul id="allTx" class="list"></ul>
    </div>
  </section>

  <!-- Checks -->
  <section id="tab-checks" class="hidden">
    <div class="card">
      <div class="row">
        <div style="flex:1"><label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><input id="chNote" placeholder="Ú†Ú© Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø®Ø±ÛŒØ¯ Ù‚Ø·Ø¹Ù‡"></div>
        <div style="width:160px"><label>Ù…Ø¨Ù„Øº</label><input id="chAmount" inputmode="numeric"></div>
        <div style="width:190px"><label>Ø³Ø±Ø±Ø³ÛŒØ¯</label><input id="chDue" type="date"></div>
        <div style="width:170px"><label>Ù†ÙˆØ¹</label><select id="chKind"><option value="pay">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</option><option value="receive">Ø¯Ø±ÛŒØ§ÙØªÛŒ</option></select></div>
      </div>
      <div class="row"><button id="btnAddCheck" class="btn primary">+ Ø«Ø¨Øª Ú†Ú©</button></div>
    </div>
    <div class="card">
      <h3>Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²</h3>
      <ul id="checksOpen" class="list"></ul>
    </div>
    <div class="card">
      <h3>Ú†Ú©â€ŒÙ‡Ø§ÛŒ ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡</h3>
      <ul id="checksClosed" class="list"></ul>
    </div>
  </section>

  <!-- Installments -->
  <section id="tab-inst" class="hidden">
    <div class="card">
      <div class="row">
        <div style="flex:1"><label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><input id="insNote" placeholder="Ù‚Ø³Ø· ÙˆØ§Ù… Ø®ÙˆØ¯Ø±Ùˆ"></div>
        <div style="width:150px"><label>Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø·</label><input id="insPer" inputmode="numeric"></div>
        <div style="width:130px"><label>ØªØ¹Ø¯Ø§Ø¯</label><input id="insCount" inputmode="numeric" placeholder="12"></div>
        <div style="width:180px"><label>Ø§ÙˆÙ„ÛŒÙ† Ø³Ø±Ø±Ø³ÛŒØ¯</label><input id="insNext" type="date"></div>
      </div>
      <div class="row"><button id="btnAddInst" class="btn primary">+ Ø«Ø¨Øª Ù‚Ø³Ø·</button></div>
    </div>
    <div class="card">
      <h3>Ø§Ù‚Ø³Ø§Ø· ÙØ¹Ø§Ù„</h3>
      <ul id="insList" class="list"></ul>
    </div>
  </section>

  <!-- People -->
  <section id="tab-people" class="hidden">
    <div class="card">
      <div class="row">
        <div style="flex:1"><label>Ù†Ø§Ù…</label><input id="pName"></div>
        <div style="width:180px"><label>Ù†Ù‚Ø´</label><select id="pRole"><option value="debtor">Ø¨Ø¯Ù‡Ú©Ø§Ø±</option><option value="creditor">Ø·Ù„Ø¨Ú©Ø§Ø±</option></select></div>
      </div>
      <div class="row"><button id="btnAddPerson" class="btn primary">+ Ø§ÙØ²ÙˆØ¯Ù† Ø´Ø®Øµ</button></div>
    </div>
    <div class="card">
      <ul id="peopleList" class="list"></ul>
    </div>
  </section>

  <!-- Accounts -->
  <section id="tab-accounts" class="hidden">
    <div class="card">
      <div class="row">
        <div style="flex:1"><label>Ù†Ø§Ù… Ø­Ø³Ø§Ø¨</label><input id="accName" placeholder="Ú©ÛŒÙ Ù¾ÙˆÙ„ / Ø¨Ø§Ù†Ú© Ù…Ù„Øª ..."></div>
      </div>
      <div class="row"><button id="btnAddAccount" class="btn primary">+ Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨</button></div>
    </div>
    <div class="card">
      <ul id="accList" class="list"></ul>
    </div>
  </section>

</main>

<!-- Modal import -->
<div id="modalImport" class="modal">
  <div class="box">
    <h3>ÙˆØ±ÙˆØ¯ JSON</h3>
    <p class="small">ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†. Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
    <input type="file" id="importFile" accept=".json,application/json"/>
    <div class="row" style="margin-top:10px">
      <button id="doImport" class="btn primary">ÙˆØ±ÙˆØ¯</button>
      <button id="closeImport" class="btn">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<footer>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ú¯ÙˆØ´ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</footer>

<script>
/* ====== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ====== */
const faDigits = d => d.replace(/[Û°-Û¹]/g, ch => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(ch));
const toNum = s => parseInt((faDigits(String(s||'')).match(/\d+/)||['0'])[0],10)||0;
const todayISO = () => new Date().toISOString().slice(0,10);

/* ====== Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ù…Ø­Ù„ÛŒ ====== */
const DB = {
  key:'va-db-v2',
  init(){
    if(!localStorage.getItem(this.key)){
      const seed={base:{assets:0,debts:0,checksTotal:0,installmentsTotal:0,start:new Date().toISOString()},
      accounts:[{id:'wallet',name:'Ú©ÛŒÙ Ù¾ÙˆÙ„'}],
      people:[], categories:[{id:'groceries',name:'Ø®ÙˆØ§Ø±ÙˆØ¨Ø§Ø±',type:'expense'},{id:'car',name:'Ø®ÙˆØ¯Ø±Ùˆ',type:'expense'},{id:'income',name:'Ø¯Ø±Ø¢Ù…Ø¯',type:'income'}],
      tx:[], checks:[], inst:[]};
      localStorage.setItem(this.key,JSON.stringify(seed));
    }
  },
  get(){return JSON.parse(localStorage.getItem(this.key))},
  set(v){localStorage.setItem(this.key,JSON.stringify(v))}
};
DB.init();

/* ====== Ú¯ÙØªØ§Ø± ====== */
const Rec = window.SpeechRecognition||window.webkitSpeechRecognition;
let rec=null;
function speak(t){ if('speechSynthesis'in window){const u=new SpeechSynthesisUtterance(t);u.lang='fa-IR';speechSynthesis.speak(u);} }
function startRec(){
  if(!Rec){alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');return}
  if(rec) try{rec.stop()}catch{}
  rec=new Rec(); rec.lang='fa-IR'; rec.interimResults=false; rec.onresult=e=>{
    const t=e.results[0][0].transcript.trim();
    parseSpeech(t);
  }; rec.onerror=console.warn; rec.start(); speak('Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù…');
}
function stopRec(){ if(rec) try{rec.stop()}catch{} speak('Ù…ØªÙˆÙ‚Ù Ø´Ø¯') }

/* ====== Ù¾Ø§Ø±Ø³ Ø¯Ø³ØªÙˆØ±Ø§Øª Ú¯ÙØªØ§Ø±ÛŒ ====== */
function parseSpeech(t){
  const txt = t;
  // Ø®Ø±Ø¬
  if(/Ø®Ø±Ø¬/.test(txt)){ const amt = parseAmount(txt); addTx({amount:-amt,note:txt}); return speak('Ø®Ø±Ø¬ Ø«Ø¨Øª Ø´Ø¯'); }
  // ÙˆØ§Ø±ÛŒØ²/Ú¯Ø±ÙØªÙ…
  if(/ÙˆØ§Ø±ÛŒØ²|Ú¯Ø±ÙØªÙ…|Ø¯Ø±ÛŒØ§ÙØª/.test(txt)){ const amt=parseAmount(txt); addTx({amount:+amt,note:txt}); return speak('ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ø´Ø¯'); }
  // Ú†Ú©
  if(/Ú†Ú©/.test(txt)){ const amt=parseAmount(txt); const due = todayISO(); addCheck({amount:amt,kind: /Ø¯Ø±ÛŒØ§ÙØª/.test(txt)?'receive':'pay', due, note:txt}); return speak('Ú†Ú© Ø«Ø¨Øª Ø´Ø¯'); }
  // Ù‚Ø³Ø·
  if(/Ù‚Ø³Ø·/.test(txt)){ const per=parseAmount(txt); addInst({per,count:12,next:todayISO(),note:txt}); return speak('Ù‚Ø³Ø· Ø«Ø¨Øª Ø´Ø¯'); }
  // ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡
  if(/ØªÙ†Ø¸ÛŒÙ…/.test(txt)) return setupWizard();
  speak('Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…');
}
function parseAmount(t){ t = faDigits(t.replace(/[^\dÛ°-Û¹]/g,' ')); return toNum(t); }

/* ====== Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø§Ø¯Ù‡ ====== */
function addTx({amount,note}){ const db=DB.get(); db.tx.push({id:crypto.randomUUID(),date:new Date().toISOString(),amount,note}); DB.set(db); render(); }
function addPerson(name,role){ const db=DB.get(); db.people.push({id:crypto.randomUUID(),name,role}); DB.set(db); renderPeople(); }
function addAccount(name){ const db=DB.get(); db.accounts.push({id:crypto.randomUUID(),name}); DB.set(db); renderAccounts(); }
function addCheck({amount,kind,due,note}){ const db=DB.get(); db.checks.push({id:crypto.randomUUID(),amount,kind,due,status:'pending',note}); DB.set(db); renderChecks(); }
function clearCheck(id){ const db=DB.get(); const c=db.checks.find(x=>x.id===id); if(c){c.status='cleared'} DB.set(db); renderChecks(); }
function addInst({per,count,next,note}){ const db=DB.get(); db.inst.push({id:crypto.randomUUID(),per,count,paid:0,next,note}); DB.set(db); renderInst(); }
function payInst(id){ const db=DB.get(); const i=db.inst.find(x=>x.id===id); if(!i) return; i.paid++; i.next = nextMonth(i.next); if(i.paid>=i.count) i.done=true; DB.set(db); renderInst(); }
function nextMonth(iso){ const d=new Date(iso); d.setMonth(d.getMonth()+1); return d.toISOString().slice(0,10); }

/* ====== Ø®Ù„Ø§ØµÙ‡ Ùˆ Ø±Ù†Ø¯Ø± ====== */
function totalsToday(){ const db=DB.get(); let inc=0,exp=0; const today=new Date().toISOString().slice(0,10);
  db.tx.forEach(t=>{ if((t.date||'').slice(0,10)===today){ if(t.amount>0) inc+=t.amount; else exp+=Math.abs(t.amount); }});
  return {inc,exp};
}
function netWorth(){ const db=DB.get(); const base=db.base.assets - db.base.debts; const sum=db.tx.reduce((a,t)=>a+t.amount,0); return base+sum; }

function renderSummary(){
  const t=totalsToday(); document.getElementById('todayIncome').textContent = t.inc.toLocaleString('fa-IR');
  document.getElementById('todayExpense').textContent = t.exp.toLocaleString('fa-IR');
  document.getElementById('netWorth').textContent = netWorth().toLocaleString('fa-IR');
}
function renderRecent(){
  const ul=document.getElementById('txList'); const db=DB.get(); const rows=db.tx.slice(-12).reverse();
  ul.innerHTML=rows.map(r=>`<li><div>${r.note||'â€”'}<div class="small">${new Date(r.date).toLocaleString('fa-IR')}</div></div><div class="${r.amount<0?'negative':'positive'}">${Math.abs(r.amount).toLocaleString('fa-IR')} Øª</div></li>`).join('');
}
function renderAllTx(){
  const ul=document.getElementById('allTx'); const db=DB.get(); const rows=db.tx.slice().reverse();
  ul.innerHTML=rows.map(r=>`<li><div>${r.note||'â€”'}<div class="small">${new Date(r.date).toLocaleString('fa-IR')}</div></div><div class="${r.amount<0?'negative':'positive'}">${Math.abs(r.amount).toLocaleString('fa-IR')} Øª</div></li>`).join('');
}
function renderChecks(){
  const db=DB.get(); const open=db.checks.filter(c=>c.status==='pending').sort((a,b)=>a.due.localeCompare(b.due));
  const closed=db.checks.filter(c=>c.status==='cleared').slice(-20).reverse();
  const o=document.getElementById('checksOpen'); const c=document.getElementById('checksClosed');
  o.innerHTML=open.map(x=>`<li><div>${x.note||'Ú†Ú©'}<div class="small">${x.kind==='pay'?'Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ':'Ø¯Ø±ÛŒØ§ÙØªÛŒ'} | Ø³Ø±Ø±Ø³ÛŒØ¯ ${x.due}</div></div><div>${x.amount.toLocaleString('fa-IR')} Øª <button class="btn" onclick="clearCheck('${x.id}')">ØªØ³ÙˆÛŒÙ‡</button></div></li>`).join('');
  c.innerHTML=closed.map(x=>`<li><div>${x.note||'Ú†Ú©'}</div><div class="small">${x.amount.toLocaleString('fa-IR')} Øª</div></li>`).join('');
}
function renderInst(){
  const db=DB.get(); const list=db.inst.filter(i=>!i.done).sort((a,b)=>a.next.localeCompare(b.next));
  const ul=document.getElementById('insList');
  ul.innerHTML=list.map(i=>`<li><div>${i.note||'Ù‚Ø³Ø·'}<div class="small">Ø¨Ø¹Ø¯ÛŒ: ${i.next} | Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡ ${i.paid}/${i.count}</div></div><div>${i.per.toLocaleString('fa-IR')} Øª <button class="btn" onclick="payInst('${i.id}')">Ù¾Ø±Ø¯Ø§Ø®Øª</button></div></li>`).join('');
}
function renderPeople(){ const db=DB.get(); const ul=document.getElementById('peopleList'); ul.innerHTML=db.people.map(p=>`<li><div>${p.name}</div><div class="badge">${p.role==='debtor'?'Ø¨Ø¯Ù‡Ú©Ø§Ø±':'Ø·Ù„Ø¨Ú©Ø§Ø±'}</div></li>`).join(''); }
function renderAccounts(){ const db=DB.get(); const ul=document.getElementById('accList'); ul.innerHTML=db.accounts.map(a=>`<li><div>${a.name}</div></li>`).join(''); }

function render(){ renderSummary(); renderRecent(); renderAllTx(); renderChecks(); renderInst(); renderPeople(); renderAccounts(); }

/* ====== ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ ====== */
async function setupWizard(){
  speak('ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯');
  const assets = await ask('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ú©Ù„ Ø§Ù„Ø§Ù† Ú†Ù‚Ø¯Ø±Ù‡ØŸ');
  const debts  = await ask('Ø¬Ù…Ø¹ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ú†Ù‚Ø¯Ø±Ù‡ØŸ');
  const checks = await ask('Ø¬Ù…Ø¹ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø² Ú†Ù‚Ø¯Ø±Ù‡ØŸ');
  const inst   = await ask('Ø¬Ù…Ø¹ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ Ú†Ù‚Ø¯Ø±Ù‡ØŸ');
  const db=DB.get(); db.base.assets=toNum(assets); db.base.debts=toNum(debts); db.base.checksTotal=toNum(checks); db.base.installmentsTotal=toNum(inst); DB.set(db);
  renderSummary(); speak('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
}
function ask(prompt){
  return new Promise(res=>{
    speak(prompt);
    const R = window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!R){ const t = window.prompt(prompt); return res(t||''); }
    const r=new R(); r.lang='fa-IR'; r.onresult=e=>{res(e.results[0][0].transcript); r.stop();}; r.onerror=_=>res(''); r.start();
  });
}

/* ====== Import/Export ====== */
function exportJSON(){
  const blob = new Blob([localStorage.getItem(DB.key)||'{}'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='voice-accountant-backup.json'; a.click();
}
function openImport(){ document.getElementById('modalImport').classList.add('show'); }
function closeImport(){ document.getElementById('modalImport').classList.remove('show'); }
async function doImport(file){
  if(!file) return; const txt=await file.text(); localStorage.setItem(DB.key,txt); closeImport(); render(); speak('ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø¯Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
}

/* ====== ØªØ¨â€ŒÙ‡Ø§ ====== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const id=t.dataset.tab; document.querySelectorAll('main>section').forEach(s=>s.classList.add('hidden'));
    document.getElementById('tab-'+id).classList.remove('hidden');
  };
});

/* ====== Ù‡Ù†Ø¯Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ====== */
document.getElementById('btnStart').onclick=startRec;
document.getElementById('btnStop').onclick=stopRec;
document.getElementById('btnSetup').onclick=setupWizard;
document.getElementById('btnExport').onclick=exportJSON;
document.getElementById('btnImport').onclick=openImport;
document.getElementById('closeImport').onclick=closeImport;
document.getElementById('doImport').onclick=()=>doImport(document.getElementById('importFile').files[0]);
document.querySelectorAll('[data-quick]').forEach(b=>{
  b.onclick=()=>{
    const k=b.dataset.quick;
    if(k==='say-exp') startRec();
    if(k==='say-inc') startRec();
    if(k==='add-check'){ const amt=toNum(prompt('Ù…Ø¨Ù„Øº Ú†Ú©ØŸ')); const due=prompt('ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (YYYY-MM-DD)?',todayISO()); const kind=confirm('Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ø³ØªØŸ ØªØ§ÛŒÛŒØ¯=Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ ØŒ Ø§Ù†ØµØ±Ø§Ù=Ø¯Ø±ÛŒØ§ÙØªÛŒ')?'pay':'receive'; addCheck({amount:amt,kind,due,note:'Ú†Ú©'}); }
    if(k==='add-inst'){ const per=toNum(prompt('Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø·ØŸ')); const count=toNum(prompt('ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·ØŸ', '12')); const next=prompt('Ø§ÙˆÙ„ÛŒÙ† Ø³Ø±Ø±Ø³ÛŒØ¯ØŸ (YYYY-MM-DD)', todayISO()); addInst({per,count,next,note:'Ù‚Ø³Ø·'}); }
  };
});

/* ØªØ±Ø§Ú©Ù†Ø´ ÙØ±Ù… Ø¯Ø³ØªÛŒ */
document.getElementById('btnAddTx').onclick=()=>{
  const note=document.getElementById('txNote').value.trim();
  const amount=toNum(document.getElementById('txAmount').value);
  const type=document.getElementById('txType').value;
  if(!amount) return alert('Ù…Ø¨Ù„ØºØŸ');
  addTx({amount:type==='income'?amount:-amount,note:note||type});
  document.getElementById('txNote').value=''; document.getElementById('txAmount').value='';
};

/* Ú†Ú© ÙØ±Ù… Ø¯Ø³ØªÛŒ */
document.getElementById('btnAddCheck').onclick=()=>{
  const note=document.getElementById('chNote').value.trim();
  const amount=toNum(document.getElementById('chAmount').value);
  const due=document.getElementById('chDue').value||todayISO();
  const kind=document.getElementById('chKind').value;
  if(!amount) return alert('Ù…Ø¨Ù„ØºØŸ');
  addCheck({amount,kind,due,note});
  document.getElementById('chNote').value=''; document.getElementById('chAmount').value='';
};

/* Ù‚Ø³Ø· ÙØ±Ù… Ø¯Ø³ØªÛŒ */
document.getElementById('btnAddInst').onclick=()=>{
  const note=document.getElementById('insNote').value.trim();
  const per=toNum(document.getElementById('insPer').value);
  const count=toNum(document.getElementById('insCount').value||'1');
  const next=document.getElementById('insNext').value||todayISO();
  if(!per||!count) return alert('Ù…Ø¨Ù„Øº/ØªØ¹Ø¯Ø§Ø¯ØŸ');
  addInst({per,count,next,note});
  document.getElementById('insNote').value=''; document.getElementById('insPer').value=''; document.getElementById('insCount').value='';
};

/* Ø§Ø´Ø®Ø§Øµ/Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ */
document.getElementById('btnAddPerson').onclick=()=>{const n=document.getElementById('pName').value.trim(); if(!n)return; addPerson(n,document.getElementById('pRole').value); document.getElementById('pName').value='';}
document.getElementById('btnAddAccount').onclick=()=>{const n=document.getElementById('accName').value.trim(); if(!n)return; addAccount(n); document.getElementById('accName').value='';}

/* ====== PWA & Push ====== */
if('serviceWorker'in navigator){ navigator.serviceWorker.register('sw.js').then(()=>{document.getElementById('pwaState').textContent='PWA ÙØ¹Ø§Ù„';}); }
document.getElementById('btnNotify').onclick=async()=>{
  if(!('Notification'in window)) return alert('Ø§Ø¹Ù„Ø§Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯');
  const perm = await Notification.requestPermission();
  if(perm!=='granted') return alert('Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¹Ù„Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯');
  if(!('serviceWorker'in navigator)) return alert('ServiceWorker Ù†ÛŒØ³Øª');
  const reg = await navigator.serviceWorker.ready;
  try{
    const sub = await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey: urlBase64ToUint8Array('BPUw0WkuhZ7lqYbzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz')});
    localStorage.setItem('va-push-sub', JSON.stringify(sub));
    alert('Ø§Ø´ØªØ±Ø§Ú© Ø§Ø¹Ù„Ø§Ù† Ø«Ø¨Øª Ø´Ø¯. Ø®Ø±ÙˆØ¬ÛŒ JSON subscription Ø±Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø¯Ù‡.');
  }catch(e){ alert('Ø®Ø·Ø§ Ø¯Ø± subscribe: '+e); }
};
function urlBase64ToUint8Array(base64String){const padding='='.repeat((4-base64String.length%4)%4);const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/');const raw=atob(base64);const arr=new Uint8Array(raw.length);for(let i=0;i<raw.length;++i)arr[i]=raw.charCodeAt(i);return arr;}

/* ====== Ø¢ØºØ§Ø² ====== */
render();
</script>
</body>
</html>
